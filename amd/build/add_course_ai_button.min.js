define("local_coursegen/add_course_ai_button",["exports","core/ajax","core/templates","core/notification","core_form/events","core_form/changechecker"],(function(_exports,_ajax,_templates,_notification,FormEvents,FormChangeChecker){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Add AI button to course creation/edit form
   *
   * @module     local_coursegen/add_course_ai_button
   * @copyright  2025 Wilber Narvaez <https://datacurso.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),FormEvents=_interopRequireWildcard(FormEvents),FormChangeChecker=_interopRequireWildcard(FormChangeChecker);_exports.init=()=>{addAIButton()};const addAIButton=async()=>{const form=document.querySelector("form.mform");if(!form)return;const submitElement=document.querySelector(".mb-3.fitem.form-submit");if(!submitElement){var _document$querySelect;const alternativeSubmit=document.querySelector('div[data-fieldtype="submit"]')||(null===(_document$querySelect=document.querySelector('input[name="saveandreturn"]'))||void 0===_document$querySelect?void 0:_document$querySelect.closest(".fitem"));return void(alternativeSubmit&&await insertAIButton(alternativeSubmit))}await insertAIButton(submitElement);const button=document.querySelector('[data-action="local_coursegen/add_ai_course"]');button&&button.addEventListener("click",(async e=>{if(e.preventDefault(),!validateElements(form))return;disableButtons(form),clearServerErrors(form);const hiddenFlag=form.querySelector('input[name="local_coursegen_create_ai_course"]');hiddenFlag&&(hiddenFlag.value=1);const formData=new URLSearchParams(new FormData(form)).toString();try{const validation=await _ajax.default.call([{methodname:"local_coursegen_validate_course_form",args:{payload:formData}}])[0];if(!validation.ok){const errorsMap={};return(validation.errors||[]).forEach((err=>{errorsMap[err.field]=err.msg})),showServerErrors(form,errorsMap),void enableButtons(form)}const response=await _ajax.default.call([{methodname:"local_coursegen_process_course_form",args:{formdata:formData}}])[0];if(!response.submitted)return void enableButtons(form);const data=response.data||{};FormEvents.notifyFormSubmittedByJavascript(form,!0),FormChangeChecker.resetFormDirtyState(form),enableButtons(form),data.redirecturl&&(window.location.href=data.redirecturl)}catch(err){enableButtons(form),_notification.default.exception(err)}}))},insertAIButton=async targetElement=>{if(document.querySelector('[data-action="local_coursegen/add_ai_course"]'))return;const{html:html}=await _templates.default.renderForPromise("local_coursegen/add_ai_course_button",{}),buttonContainer=document.createElement("div");buttonContainer.innerHTML=html,targetElement.parentNode.insertBefore(buttonContainer,targetElement)},validateElements=form=>{FormEvents.notifyFormSubmittedByJavascript(form);const invalid=[...form.querySelectorAll('[aria-invalid="true"], .error')];if(invalid.length){const focusField=invalid[0];return focusField.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout((()=>{focusField.focus({preventScroll:!0})}),0),!1}return!0},disableButtons=form=>{form.querySelectorAll('input[type="submit"], button[type="submit"]').forEach((el=>el.setAttribute("disabled",!0)))},enableButtons=form=>{form.querySelectorAll('input[type="submit"], button[type="submit"]').forEach((el=>el.removeAttribute("disabled")))},clearServerErrors=form=>{form.querySelectorAll(".is-invalid").forEach((el=>el.classList.remove("is-invalid"))),form.querySelectorAll('.form-control-feedback.invalid-feedback[data-from-aicourse="1"]').forEach((el=>el.remove()))},showServerErrors=(form,errors)=>{let focusField=null;Object.entries(errors).forEach((_ref=>{let[field,msg]=_ref;if("_general"===field)return;const input=form.querySelector("#id_".concat(field));if(!input)return;input.classList.add("is-invalid");let feedback=form.querySelector("#id_error_".concat(field));feedback||(feedback=document.createElement("div"),feedback.className="form-control-feedback invalid-feedback",input.insertAdjacentElement("afterend",feedback)),feedback.setAttribute("data-from-aicourse","1"),feedback.textContent=msg,feedback.style.display="block",focusField||(focusField=input)})),focusField&&(focusField.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout((()=>{focusField.focus({preventScroll:!0})}),0))}}));

//# sourceMappingURL=add_course_ai_button.min.js.map