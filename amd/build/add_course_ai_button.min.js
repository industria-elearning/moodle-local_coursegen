define("local_coursegen/add_course_ai_button",["exports","core/ajax","core/templates"],(function(_exports,_ajax,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Add AI button to course creation/edit form
   *
   * @module     local_coursegen/add_course_ai_button
   * @copyright  2025 Wilber Narvaez <https://datacurso.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);const OTHER_FLAG="data-aicourse-pending",NEW_ACTION_URL=M.cfg.wwwroot+"/local/coursegen/createcourseai.php";_exports.init=()=>{addAIButton()};const addAIButton=async()=>{const form=document.querySelector("form.mform");if(!form)return;const submitElement=document.querySelector(".mb-3.fitem.form-submit");if(!submitElement){var _document$querySelect;const alternativeSubmit=document.querySelector('div[data-fieldtype="submit"]')||(null===(_document$querySelect=document.querySelector('input[name="saveandreturn"]'))||void 0===_document$querySelect?void 0:_document$querySelect.closest(".fitem"));return void(alternativeSubmit&&await insertAIButton(alternativeSubmit))}await insertAIButton(submitElement);const button=document.querySelector('[data-action="local_coursegen/add_ai_course"]');if(!button)return;const originalAction=form.getAttribute("action")||window.location.href;button.addEventListener("click",(()=>{form.setAttribute(OTHER_FLAG,"1"),form.addEventListener("submit",(e=>onAICourseSubmit(e,form,originalAction)),{once:!0})}))},onAICourseSubmit=async(e,form,originalAction)=>{if(!form.hasAttribute(OTHER_FLAG))return;if(form.hasAttribute("data-aicourse-bypass"))return;if(e.defaultPrevented)return void form.removeAttribute(OTHER_FLAG);e.preventDefault(),clearServerErrors(form);const hiddenFlag=form.querySelector('input[name="local_coursegen_create_ai_course"]');hiddenFlag&&(hiddenFlag.value=1);const payload=new URLSearchParams(new FormData(form)).toString();try{const result=await _ajax.default.call([{methodname:"local_coursegen_validate_course_form",args:{payload:payload}}])[0];if(!result.ok){const errorsMap={};return(result.errors||[]).forEach((err=>{errorsMap[err.field]=err.msg})),showServerErrors(form,errorsMap),void form.setAttribute("action",originalAction)}form.setAttribute("data-aicourse-bypass","1"),form.setAttribute("action",NEW_ACTION_URL),form.submit()}catch(err){form.setAttribute("action",originalAction)}finally{form.removeAttribute("data-aicourse-bypass"),form.removeAttribute(OTHER_FLAG)}},insertAIButton=async targetElement=>{if(document.querySelector('[data-action="local_coursegen/add_ai_course"]'))return;const{html:html}=await _templates.default.renderForPromise("local_coursegen/add_ai_course_button",{}),buttonContainer=document.createElement("div");buttonContainer.innerHTML=html,targetElement.parentNode.insertBefore(buttonContainer,targetElement)},clearServerErrors=form=>{form.querySelectorAll(".is-invalid").forEach((el=>el.classList.remove("is-invalid"))),form.querySelectorAll('.form-control-feedback.invalid-feedback[data-from-aicourse="1"]').forEach((el=>el.remove()))},showServerErrors=(form,errors)=>{Object.entries(errors).forEach((_ref=>{let[field,msg]=_ref;if("_general"===field)return;const input=form.querySelector("#id_".concat(field));if(!input)return;input.classList.add("is-invalid");let feedback=form.querySelector("#id_error_".concat(field));feedback||(feedback=document.createElement("div"),feedback.className="form-control-feedback invalid-feedback",input.insertAdjacentElement("afterend",feedback)),feedback.setAttribute("data-from-aicourse","1"),feedback.textContent=msg,feedback.style.display="block"}))}}));

//# sourceMappingURL=add_course_ai_button.min.js.map