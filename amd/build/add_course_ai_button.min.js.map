{"version":3,"file":"add_course_ai_button.min.js","sources":["../src/add_course_ai_button.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add AI button to course creation/edit form\n *\n * @module     local_coursegen/add_course_ai_button\n * @copyright  2025 Wilber Narvaez <https://datacurso.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from \"core/ajax\";\nimport Templates from \"core/templates\";\n\nconst OTHER_FLAG = \"data-aicourse-pending\";\nconst BYPASS_FLAG = \"data-aicourse-bypass\";\nconst VALIDATE_WS = \"local_coursegen_validate_course_form\";\nconst NEW_ACTION_URL =\n  M.cfg.wwwroot + \"/local/coursegen/createcourseai.php\";\n\n/**\n * Initialize the AI button functionality\n */\nexport const init = () => {\n  addAIButton();\n};\n\n/**\n * Add the AI button before the submit button\n */\nconst addAIButton = async () => {\n  const form = document.querySelector(\"form.mform\");\n  if (!form) {\n    return;\n  }\n\n  // Find the submit form element\n  const submitElement = document.querySelector(\".mb-3.fitem.form-submit\");\n\n  if (!submitElement) {\n    // If not found, try alternative selectors\n    const alternativeSubmit =\n      document.querySelector('div[data-fieldtype=\"submit\"]') ||\n      document.querySelector('input[name=\"saveandreturn\"]')?.closest(\".fitem\");\n\n    if (alternativeSubmit) {\n      await insertAIButton(alternativeSubmit);\n    }\n    return;\n  }\n\n  await insertAIButton(submitElement);\n  const button = document.querySelector(\n    '[data-action=\"local_coursegen/add_ai_course\"]'\n  );\n  if (!button) {\n    return;\n  }\n\n  const originalAction = form.getAttribute(\"action\") || window.location.href;\n\n  button.addEventListener(\"click\", () => {\n    form.setAttribute(OTHER_FLAG, \"1\");\n    form.addEventListener(\n      \"submit\",\n      (e) => onAICourseSubmit(e, form, originalAction),\n      {once: true}\n    );\n  });\n};\n\n/**\n * Handle the AI button click event\n * @param {Event} e - The click event\n * @param {HTMLFormElement} form - The course edit form element\n * @param {string} originalAction - The original form action URL\n */\nconst onAICourseSubmit = async (e, form, originalAction) => {\n  if (!form.hasAttribute(OTHER_FLAG)) {\n    return;\n  }\n  if (form.hasAttribute(BYPASS_FLAG)) {\n    return;\n  }\n\n  if (e.defaultPrevented) {\n    form.removeAttribute(OTHER_FLAG);\n    return;\n  }\n\n  e.preventDefault();\n\n  clearServerErrors(form);\n\n  const hiddenFlag = form.querySelector(\n    'input[name=\"local_coursegen_create_ai_course\"]'\n  );\n  if (hiddenFlag) {\n    hiddenFlag.value = 1;\n  }\n\n  const payload = new URLSearchParams(new FormData(form)).toString();\n\n  try {\n    const result = await Ajax.call([\n      {\n        methodname: VALIDATE_WS,\n        args: { payload },\n      },\n    ])[0];\n\n    if (!result.ok) {\n      const errorsMap = {};\n      (result.errors || []).forEach((err) => {\n        errorsMap[err.field] = err.msg;\n      });\n\n      showServerErrors(form, errorsMap);\n      form.setAttribute(\"action\", originalAction);\n      return;\n    }\n\n    form.setAttribute(BYPASS_FLAG, \"1\");\n    form.setAttribute(\"action\", NEW_ACTION_URL);\n    form.submit();\n  } catch (err) {\n    form.setAttribute(\"action\", originalAction);\n  } finally {\n    form.removeAttribute(BYPASS_FLAG);\n    form.removeAttribute(OTHER_FLAG);\n  }\n};\n\n/**\n * Insert the AI button before the target element\n * @param {Element} targetElement - The element before which to insert the button\n */\nconst insertAIButton = async (targetElement) => {\n  // Check if button already exists to avoid duplicates\n  if (document.querySelector('[data-action=\"local_coursegen/add_ai_course\"]')) {\n    return;\n  }\n\n  // Render the template (no context needed as template is self-contained)\n  const { html } = await Templates.renderForPromise(\n    \"local_coursegen/add_ai_course_button\",\n    {}\n  );\n  const buttonContainer = document.createElement(\"div\");\n  buttonContainer.innerHTML = html;\n\n  // Insert before the submit element\n  targetElement.parentNode.insertBefore(buttonContainer, targetElement);\n};\n\nconst clearServerErrors = (form) => {\n  form.querySelectorAll(\".is-invalid\").forEach((el) =>\n    el.classList.remove(\"is-invalid\")\n  );\n  form\n    .querySelectorAll(\n      '.form-control-feedback.invalid-feedback[data-from-aicourse=\"1\"]'\n    )\n    .forEach((el) => el.remove());\n};\n\nconst showServerErrors = (form, errors) => {\n  let focusField = null;\n  Object.entries(errors).forEach(([field, msg]) => {\n    if (field === \"_general\") {\n      return;\n    }\n\n    const input = form.querySelector(`#id_${field}`);\n    if (!input) {\n      return;\n    }\n\n    input.classList.add(\"is-invalid\");\n\n    let feedback = form.querySelector(`#id_error_${field}`);\n    if (!feedback) {\n      feedback = document.createElement(\"div\");\n      feedback.className = \"form-control-feedback invalid-feedback\";\n      input.insertAdjacentElement(\"afterend\", feedback);\n    }\n\n    feedback.setAttribute(\"data-from-aicourse\", \"1\");\n    feedback.textContent = msg;\n    feedback.style.display = \"block\";\n\n    if (!focusField) {\n      focusField = input;\n    }\n  });\n\n  if (focusField) {\n    focusField.scrollIntoView({\n      behavior: \"smooth\",\n      block: \"center\",\n    });\n\n    setTimeout(() => {\n      focusField.focus({preventScroll: true});\n    }, 0);\n  }\n};\n"],"names":["OTHER_FLAG","NEW_ACTION_URL","M","cfg","wwwroot","addAIButton","async","form","document","querySelector","submitElement","alternativeSubmit","_document$querySelect","closest","insertAIButton","button","originalAction","getAttribute","window","location","href","addEventListener","setAttribute","e","onAICourseSubmit","once","hasAttribute","defaultPrevented","removeAttribute","preventDefault","clearServerErrors","hiddenFlag","value","payload","URLSearchParams","FormData","toString","result","Ajax","call","methodname","args","ok","errorsMap","errors","forEach","err","field","msg","showServerErrors","submit","html","Templates","renderForPromise","buttonContainer","createElement","innerHTML","targetElement","parentNode","insertBefore","querySelectorAll","el","classList","remove","focusField","Object","entries","_ref","input","add","feedback","className","insertAdjacentElement","textContent","style","display","scrollIntoView","behavior","block","setTimeout","focus","preventScroll"],"mappings":";;;;;;;0KA0BMA,WAAa,wBAGbC,eACJC,EAAEC,IAAIC,QAAU,oDAKE,KAClBC,qBAMIA,YAAcC,gBACZC,KAAOC,SAASC,cAAc,kBAC/BF,kBAKCG,cAAgBF,SAASC,cAAc,+BAExCC,cAAe,iCAEZC,kBACJH,SAASC,cAAc,gEACvBD,SAASC,cAAc,uEAAvBG,sBAAuDC,QAAQ,uBAE7DF,yBACIG,eAAeH,0BAKnBG,eAAeJ,qBACfK,OAASP,SAASC,cACtB,qDAEGM,oBAICC,eAAiBT,KAAKU,aAAa,WAAaC,OAAOC,SAASC,KAEtEL,OAAOM,iBAAiB,SAAS,KAC/Bd,KAAKe,aAAatB,WAAY,KAC9BO,KAAKc,iBACH,UACCE,GAAMC,iBAAiBD,EAAGhB,KAAMS,iBACjC,CAACS,MAAM,QAWPD,iBAAmBlB,MAAOiB,EAAGhB,KAAMS,sBAClCT,KAAKmB,aAAa1B,sBAGnBO,KAAKmB,aAlES,kCAsEdH,EAAEI,6BACJpB,KAAKqB,gBAAgB5B,YAIvBuB,EAAEM,iBAEFC,kBAAkBvB,YAEZwB,WAAaxB,KAAKE,cACtB,kDAEEsB,aACFA,WAAWC,MAAQ,SAGfC,QAAU,IAAIC,gBAAgB,IAAIC,SAAS5B,OAAO6B,qBAGhDC,aAAeC,cAAKC,KAAK,CAC7B,CACEC,WA1FY,uCA2FZC,KAAM,CAAER,QAAAA,YAET,OAEEI,OAAOK,GAAI,OACRC,UAAY,UACjBN,OAAOO,QAAU,IAAIC,SAASC,MAC7BH,UAAUG,IAAIC,OAASD,IAAIE,OAG7BC,iBAAiB1C,KAAMoC,gBACvBpC,KAAKe,aAAa,SAAUN,gBAI9BT,KAAKe,aA3GW,uBA2Ge,KAC/Bf,KAAKe,aAAa,SAAUrB,gBAC5BM,KAAK2C,SACL,MAAOJ,KACPvC,KAAKe,aAAa,SAAUN,wBAE5BT,KAAKqB,gBAjHW,wBAkHhBrB,KAAKqB,gBAAgB5B,cAQnBc,eAAiBR,MAAAA,mBAEjBE,SAASC,cAAc,8DAKrB0C,KAAEA,YAAeC,mBAAUC,iBAC/B,uCACA,IAEIC,gBAAkB9C,SAAS+C,cAAc,OAC/CD,gBAAgBE,UAAYL,KAG5BM,cAAcC,WAAWC,aAAaL,gBAAiBG,gBAGnD3B,kBAAqBvB,OACzBA,KAAKqD,iBAAiB,eAAef,SAASgB,IAC5CA,GAAGC,UAAUC,OAAO,gBAEtBxD,KACGqD,iBACC,mEAEDf,SAASgB,IAAOA,GAAGE,YAGlBd,iBAAmB,CAAC1C,KAAMqC,cAC1BoB,WAAa,KACjBC,OAAOC,QAAQtB,QAAQC,SAAQsB,WAAEpB,MAAOC,aACxB,aAAVD,mBAIEqB,MAAQ7D,KAAKE,4BAAqBsC,YACnCqB,aAILA,MAAMN,UAAUO,IAAI,kBAEhBC,SAAW/D,KAAKE,kCAA2BsC,QAC1CuB,WACHA,SAAW9D,SAAS+C,cAAc,OAClCe,SAASC,UAAY,yCACrBH,MAAMI,sBAAsB,WAAYF,WAG1CA,SAAShD,aAAa,qBAAsB,KAC5CgD,SAASG,YAAczB,IACvBsB,SAASI,MAAMC,QAAU,QAEpBX,aACHA,WAAaI,UAIbJ,aACFA,WAAWY,eAAe,CACxBC,SAAU,SACVC,MAAO,WAGTC,YAAW,KACTf,WAAWgB,MAAM,CAACC,eAAe,MAChC"}