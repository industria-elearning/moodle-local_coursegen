{"version":3,"file":"add_course_ai_button.min.js","sources":["../src/add_course_ai_button.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add AI button to course creation/edit form\n *\n * @module     local_coursegen/add_course_ai_button\n * @copyright  2025 Wilber Narvaez <https://datacurso.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from \"core/ajax\";\nimport Templates from \"core/templates\";\nimport Notification from \"core/notification\";\nimport * as FormEvents from \"core_form/events\";\nimport * as FormChangeChecker from \"core_form/changechecker\";\n\nconst VALIDATE_WS = \"local_coursegen_validate_course_form\";\nconst PROCESS_WS = \"local_coursegen_process_course_form\";\n\n/**\n * Initialize the AI button functionality\n */\nexport const init = () => {\n  addAIButton();\n};\n\n/**\n * Add the AI button before the submit button\n */\nconst addAIButton = async() => {\n  const form = document.querySelector(\"form.mform\");\n  if (!form) {\n    return;\n  }\n\n  // Find the submit form element\n  const submitElement = document.querySelector(\".mb-3.fitem.form-submit\");\n\n  if (!submitElement) {\n    // If not found, try alternative selectors\n    const alternativeSubmit =\n      document.querySelector('div[data-fieldtype=\"submit\"]') ||\n      document.querySelector('input[name=\"saveandreturn\"]')?.closest(\".fitem\");\n\n    if (alternativeSubmit) {\n      await insertAIButton(alternativeSubmit);\n    }\n    return;\n  }\n\n  await insertAIButton(submitElement);\n  const button = document.querySelector(\n    '[data-action=\"local_coursegen/add_ai_course\"]'\n  );\n  if (!button) {\n    return;\n  }\n\n  button.addEventListener(\"click\", async(e) => {\n    e.preventDefault();\n\n    // If we found invalid fields, focus on the first one and do not submit via ajax.\n    if (!validateElements(form)) {\n      return;\n    }\n\n    disableButtons(form);\n    clearServerErrors(form);\n\n    const hiddenFlag = form.querySelector(\n      'input[name=\"local_coursegen_create_ai_course\"]'\n    );\n    if (hiddenFlag) {\n      hiddenFlag.value = 1;\n    }\n\n    const formData = new URLSearchParams(new FormData(form)).toString();\n\n    try {\n      // Primero, validación servidor.\n      const validation = await Ajax.call([\n        {\n          methodname: VALIDATE_WS,\n          args: {payload: formData},\n        },\n      ])[0];\n\n      if (!validation.ok) {\n        const errorsMap = {};\n        (validation.errors || []).forEach((err) => {\n          errorsMap[err.field] = err.msg;\n        });\n        showServerErrors(form, errorsMap);\n        enableButtons(form);\n        return;\n      }\n\n      // Si la validación OK, procesar vía webservice dinámico.\n      const response = await Ajax.call([\n        {\n          methodname: PROCESS_WS,\n          args: {formdata: formData},\n        },\n      ])[0];\n\n      if (!response.submitted) {\n        enableButtons(form);\n        return;\n      }\n\n      const data = response.data || {};\n\n      // Form was submitted properly: limpiar estado dirty y redirigir.\n      FormEvents.notifyFormSubmittedByJavascript(form, true);\n      FormChangeChecker.resetFormDirtyState(form);\n      enableButtons(form);\n\n      if (data.redirecturl) {\n        window.location.href = data.redirecturl;\n      }\n    } catch (err) {\n      enableButtons(form);\n      Notification.exception(err);\n    }\n  });\n};\n\n/**\n * Insert the AI button before the target element\n * @param {Element} targetElement - The element before which to insert the button\n */\nconst insertAIButton = async(targetElement) => {\n  // Check if button already exists to avoid duplicates\n  if (document.querySelector('[data-action=\"local_coursegen/add_ai_course\"]')) {\n    return;\n  }\n\n  // Render the template (no context needed as template is self-contained)\n  const { html } = await Templates.renderForPromise(\n    \"local_coursegen/add_ai_course_button\",\n    {}\n  );\n  const buttonContainer = document.createElement(\"div\");\n  buttonContainer.innerHTML = html;\n\n  // Insert before the submit element\n  targetElement.parentNode.insertBefore(buttonContainer, targetElement);\n};\n\nconst validateElements = (form) => {\n  // Notificar envío JS (resetea autosave Atto, etc.).\n  FormEvents.notifyFormSubmittedByJavascript(form);\n\n  // Ahora verificamos campos inválidos.\n  const invalid = [...form.querySelectorAll('[aria-invalid=\"true\"], .error')];\n  if (invalid.length) {\n    const focusField = invalid[0];\n    focusField.scrollIntoView({\n      behavior: \"smooth\",\n      block: \"center\",\n    });\n    setTimeout(() => {\n      focusField.focus({preventScroll: true});\n    }, 0);\n    return false;\n  }\n\n  return true;\n};\n\nconst disableButtons = (form) => {\n  form\n    .querySelectorAll('input[type=\"submit\"], button[type=\"submit\"]')\n    .forEach((el) => el.setAttribute(\"disabled\", true));\n};\n\nconst enableButtons = (form) => {\n  form\n    .querySelectorAll('input[type=\"submit\"], button[type=\"submit\"]')\n    .forEach((el) => el.removeAttribute(\"disabled\"));\n};\n\nconst clearServerErrors = (form) => {\n  form.querySelectorAll(\".is-invalid\").forEach((el) =>\n    el.classList.remove(\"is-invalid\")\n  );\n  form\n    .querySelectorAll(\n      '.form-control-feedback.invalid-feedback[data-from-aicourse=\"1\"]'\n    )\n    .forEach((el) => el.remove());\n};\n\nconst showServerErrors = (form, errors) => {\n  let focusField = null;\n  Object.entries(errors).forEach(([field, msg]) => {\n    if (field === \"_general\") {\n      return;\n    }\n\n    const input = form.querySelector(`#id_${field}`);\n    if (!input) {\n      return;\n    }\n\n    input.classList.add(\"is-invalid\");\n\n    let feedback = form.querySelector(`#id_error_${field}`);\n    if (!feedback) {\n      feedback = document.createElement(\"div\");\n      feedback.className = \"form-control-feedback invalid-feedback\";\n      input.insertAdjacentElement(\"afterend\", feedback);\n    }\n\n    feedback.setAttribute(\"data-from-aicourse\", \"1\");\n    feedback.textContent = msg;\n    feedback.style.display = \"block\";\n\n    if (!focusField) {\n      focusField = input;\n    }\n  });\n\n  if (focusField) {\n    focusField.scrollIntoView({\n      behavior: \"smooth\",\n      block: \"center\",\n    });\n\n    setTimeout(() => {\n      focusField.focus({preventScroll: true});\n    }, 0);\n  }\n};\n"],"names":["addAIButton","async","form","document","querySelector","submitElement","alternativeSubmit","_document$querySelect","closest","insertAIButton","button","addEventListener","e","preventDefault","validateElements","disableButtons","clearServerErrors","hiddenFlag","value","formData","URLSearchParams","FormData","toString","validation","Ajax","call","methodname","args","payload","ok","errorsMap","errors","forEach","err","field","msg","showServerErrors","enableButtons","response","formdata","submitted","data","FormEvents","notifyFormSubmittedByJavascript","FormChangeChecker","resetFormDirtyState","redirecturl","window","location","href","exception","html","Templates","renderForPromise","buttonContainer","createElement","innerHTML","targetElement","parentNode","insertBefore","invalid","querySelectorAll","length","focusField","scrollIntoView","behavior","block","setTimeout","focus","preventScroll","el","setAttribute","removeAttribute","classList","remove","Object","entries","_ref","input","add","feedback","className","insertAdjacentElement","textContent","style","display"],"mappings":";;;;;;;kVAmCoB,KAClBA,qBAMIA,YAAcC,gBACZC,KAAOC,SAASC,cAAc,kBAC/BF,kBAKCG,cAAgBF,SAASC,cAAc,+BAExCC,cAAe,iCAEZC,kBACJH,SAASC,cAAc,gEACvBD,SAASC,cAAc,uEAAvBG,sBAAuDC,QAAQ,uBAE7DF,yBACIG,eAAeH,0BAKnBG,eAAeJ,qBACfK,OAASP,SAASC,cACtB,iDAEGM,QAILA,OAAOC,iBAAiB,SAASV,MAAAA,OAC/BW,EAAEC,kBAGGC,iBAAiBZ,aAItBa,eAAeb,MACfc,kBAAkBd,YAEZe,WAAaf,KAAKE,cACtB,kDAEEa,aACFA,WAAWC,MAAQ,SAGfC,SAAW,IAAIC,gBAAgB,IAAIC,SAASnB,OAAOoB,qBAIjDC,iBAAmBC,cAAKC,KAAK,CACjC,CACEC,WAlEU,uCAmEVC,KAAM,CAACC,QAAST,aAEjB,OAEEI,WAAWM,GAAI,OACZC,UAAY,UACjBP,WAAWQ,QAAU,IAAIC,SAASC,MACjCH,UAAUG,IAAIC,OAASD,IAAIE,OAE7BC,iBAAiBlC,KAAM4B,gBACvBO,cAAcnC,YAKVoC,eAAiBd,cAAKC,KAAK,CAC/B,CACEC,WAnFS,sCAoFTC,KAAM,CAACY,SAAUpB,aAElB,OAEEmB,SAASE,sBACZH,cAAcnC,YAIVuC,KAAOH,SAASG,MAAQ,GAG9BC,WAAWC,gCAAgCzC,MAAM,GACjD0C,kBAAkBC,oBAAoB3C,MACtCmC,cAAcnC,MAEVuC,KAAKK,cACPC,OAAOC,SAASC,KAAOR,KAAKK,aAE9B,MAAOb,KACPI,cAAcnC,4BACDgD,UAAUjB,UASvBxB,eAAiBR,MAAAA,mBAEjBE,SAASC,cAAc,8DAKrB+C,KAAEA,YAAeC,mBAAUC,iBAC/B,uCACA,IAEIC,gBAAkBnD,SAASoD,cAAc,OAC/CD,gBAAgBE,UAAYL,KAG5BM,cAAcC,WAAWC,aAAaL,gBAAiBG,gBAGnD3C,iBAAoBZ,OAExBwC,WAAWC,gCAAgCzC,YAGrC0D,QAAU,IAAI1D,KAAK2D,iBAAiB,qCACtCD,QAAQE,OAAQ,OACZC,WAAaH,QAAQ,UAC3BG,WAAWC,eAAe,CACxBC,SAAU,SACVC,MAAO,WAETC,YAAW,KACTJ,WAAWK,MAAM,CAACC,eAAe,MAChC,IACI,SAGF,GAGHtD,eAAkBb,OACtBA,KACG2D,iBAAiB,+CACjB7B,SAASsC,IAAOA,GAAGC,aAAa,YAAY,MAG3ClC,cAAiBnC,OACrBA,KACG2D,iBAAiB,+CACjB7B,SAASsC,IAAOA,GAAGE,gBAAgB,eAGlCxD,kBAAqBd,OACzBA,KAAK2D,iBAAiB,eAAe7B,SAASsC,IAC5CA,GAAGG,UAAUC,OAAO,gBAEtBxE,KACG2D,iBACC,mEAED7B,SAASsC,IAAOA,GAAGI,YAGlBtC,iBAAmB,CAAClC,KAAM6B,cAC1BgC,WAAa,KACjBY,OAAOC,QAAQ7C,QAAQC,SAAQ6C,WAAE3C,MAAOC,aACxB,aAAVD,mBAIE4C,MAAQ5E,KAAKE,4BAAqB8B,YACnC4C,aAILA,MAAML,UAAUM,IAAI,kBAEhBC,SAAW9E,KAAKE,kCAA2B8B,QAC1C8C,WACHA,SAAW7E,SAASoD,cAAc,OAClCyB,SAASC,UAAY,yCACrBH,MAAMI,sBAAsB,WAAYF,WAG1CA,SAAST,aAAa,qBAAsB,KAC5CS,SAASG,YAAchD,IACvB6C,SAASI,MAAMC,QAAU,QAEpBtB,aACHA,WAAae,UAIbf,aACFA,WAAWC,eAAe,CACxBC,SAAU,SACVC,MAAO,WAGTC,YAAW,KACTJ,WAAWK,MAAM,CAACC,eAAe,MAChC"}