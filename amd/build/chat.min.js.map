{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Floating chat for AI assistant in course contexts (con SSE)\n *\n * @module     local_datacurso/chat\n * @copyright  2025 Datacurso\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['core/ajax', 'core/notification'], function (Ajax, notification) {\n    'use strict';\n\n    class DatacursoChat {\n        /**\n         * Constructor for DatacursoChat class.\n         * Initializes chat widget state and starts initialization.\n         */\n        constructor() {\n            this.chatWidget = null;\n            this.isMinimized = true;\n            this.userRole = 'Estudiante';\n            this.courseId = null;\n            this.isInCourseContext = false;\n\n            // Estado SSE\n            this.currentEventSource = null;\n            this.currentAIMessageEl = null;\n            this.streaming = false;\n            this.currentSessionId = null;\n\n            // Cleanup session on page unload\n            window.addEventListener('beforeunload', () => this.cleanupSession());\n\n            this.init();\n        }\n\n        /**\n         * Initializes the chat widget if in course context.\n         */\n        init() {\n            try {\n                if (!this.checkCourseContext()) return;\n                this.detectUserRole();\n                this.createChatWidget();\n                this.addEventListeners();\n            } catch (error) {\n                if (window.console) console.error('Error initializing chat:', error);\n            }\n        }\n\n        /**\n         * Checks if the current page is in a course context.\n         * @returns {boolean}\n         */\n        checkCourseContext() {\n            try {\n                if (window.datacurso_chat_config && window.datacurso_chat_config.courseid > 0) {\n                    this.courseId = parseInt(window.datacurso_chat_config.courseid, 10);\n                    this.isInCourseContext = true;\n                    return true;\n                }\n\n                const url = window.location.href;\n                const courseMatch = url.match(/course\\/view\\.php\\?id=(\\d+)/);\n                const modMatch = url.match(/mod\\/\\w+\\/view\\.php.*course=(\\d+)/);\n                const activityMatch = url.match(/course\\/modedit\\.php.*course=(\\d+)/);\n\n                if (courseMatch) {\n                    this.courseId = parseInt(courseMatch[1], 10);\n                    this.isInCourseContext = true;\n                    return true;\n                } else if (modMatch) {\n                    this.courseId = parseInt(modMatch[1], 10);\n                    this.isInCourseContext = true;\n                    return true;\n                } else if (activityMatch) {\n                    this.courseId = parseInt(activityMatch[1], 10);\n                    this.isInCourseContext = true;\n                    return true;\n                }\n\n                const courseContent = document.querySelector('#page-course-view') ||\n                    document.querySelector('.course-content') ||\n                    document.querySelector('[data-region=\"course-content\"]') ||\n                    document.querySelector('body.path-course') ||\n                    document.querySelector('body.path-mod');\n\n                if (courseContent) {\n                    const courseIdElement = document.querySelector('[data-courseid]');\n                    if (courseIdElement) {\n                        const courseIdValue = courseIdElement.getAttribute('data-courseid');\n                        if (courseIdValue && !isNaN(courseIdValue)) this.courseId = parseInt(courseIdValue, 10);\n                    }\n                    this.isInCourseContext = true;\n                    return true;\n                }\n\n                return false;\n            } catch (error) {\n                if (window.console) console.warn('Error checking course context:', error);\n                return false;\n            }\n        }\n\n        /**\n         * Detects the user's role (Teacher or Student).\n         */\n        detectUserRole() {\n            try {\n                if (window.datacurso_chat_config && window.datacurso_chat_config.userrole) {\n                    const role = window.datacurso_chat_config.userrole;\n                    if (typeof role === 'string' && role.trim()) {\n                        this.userRole = role.trim();\n                        return;\n                    }\n                }\n\n                const teacherElements = [\n                    '.editing',\n                    '[data-role=\"teacher\"]',\n                    '.teacher-view',\n                    '.course-editing',\n                    'body.editing'\n                ];\n\n                for (const selector of teacherElements) {\n                    try {\n                        if (document.querySelector(selector)) {\n                            this.userRole = 'Profesor';\n                            return;\n                        }\n                    } catch (_) {}\n                }\n\n                const userMenu = document.querySelector('.usermenu') || document.querySelector('.user-menu');\n                if (userMenu && userMenu.textContent && userMenu.textContent.toLowerCase().includes('profesor')) {\n                    this.userRole = 'Profesor';\n                    return;\n                }\n\n                if (document.querySelector('a[href*=\"edit=on\"]') ||\n                    document.querySelector('.turn-editing-on') ||\n                    document.querySelector('.editing-on')) {\n                    this.userRole = 'Profesor';\n                    return;\n                }\n\n                this.userRole = 'Estudiante';\n            } catch (error) {\n                if (window.console) console.warn('Error detecting user role:', error);\n                this.userRole = 'Estudiante';\n            }\n        }\n\n        /**\n         * Creates the chat widget and appends it to the DOM.\n         */\n        createChatWidget() {\n            const chatHTML = `\n                <div class=\"datacurso-chat-widget\" id=\"datacursoChat\">\n                    <div class=\"datacurso-chat-header\" id=\"chatHeader\">\n                        <div class=\"datacurso-chat-header-content\">\n                            <h3>Asistente IA</h3>\n                            <span class=\"datacurso-chat-role\" id=\"userRole\">${this.userRole}</span>\n                        </div>\n                        <button class=\"datacurso-chat-toggle\" id=\"toggleBtn\" aria-label=\"Minimizar/Maximizar chat\">-</button>\n                    </div>\n\n                    <div class=\"datacurso-chat-body\" id=\"chatBody\">\n                        <div class=\"datacurso-chat-messages\" id=\"chatMessages\">\n                            <div class=\"datacurso-chat-message ai\">\n                                ¡Hola! Soy tu asistente de IA. ¿En qué puedo ayudarte hoy?\n                            </div>\n                        </div>\n\n                        <div class=\"datacurso-chat-input-container\">\n                            <div class=\"datacurso-chat-input-wrapper\">\n                                <textarea\n                                    class=\"datacurso-chat-input\"\n                                    id=\"chatInput\"\n                                    placeholder=\"Escribe tu mensaje...\"\n                                    rows=\"1\"\n                                    aria-label=\"Mensaje para el asistente IA\"></textarea>\n                                <button id=\"sendBtn\" class=\"datacurso-chat-send\" aria-label=\"Enviar mensaje\">\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                                        <line x1=\"22\" y1=\"2\" x2=\"11\" y2=\"13\"></line>\n                                        <polygon points=\"22,2 15,22 11,13 2,9\"></polygon>\n                                    </svg>\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"datacurso-chat-footer\">\n                        Powered by Datacurso IA\n                    </div>\n                </div>\n            `;\n\n            const chatContainer = document.createElement('div');\n            chatContainer.innerHTML = chatHTML;\n            this.chatWidget = chatContainer.firstElementChild;\n\n            const body = this.chatWidget.querySelector('#chatBody');\n            const toggleBtn = this.chatWidget.querySelector('#toggleBtn');\n\n            if (this.isMinimized) {\n                this.chatWidget.classList.add('minimized');\n                body.style.display = 'none';\n                toggleBtn.textContent = '+';\n                toggleBtn.setAttribute('aria-label', 'Maximizar chat');\n            } else {\n                body.style.display = 'flex';\n                toggleBtn.textContent = '-';\n                toggleBtn.setAttribute('aria-label', 'Minimizar chat');\n            }\n\n            document.body.appendChild(this.chatWidget);\n\n            requestAnimationFrame(() => {\n                setTimeout(() => {\n                    if (this.chatWidget) this.chatWidget.classList.add('show');\n                }, 100);\n            });\n        }\n\n        /**\n         * Adds event listeners to chat widget elements.\n         */\n        addEventListeners() {\n            const header = this.chatWidget.querySelector('#chatHeader');\n            const sendBtn = this.chatWidget.querySelector('#sendBtn');\n            const input = this.chatWidget.querySelector('#chatInput');\n\n            header.addEventListener('click', () => this.toggleChat());\n            sendBtn.addEventListener('click', () => this.sendMessage());\n\n            input.addEventListener('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            input.addEventListener('input', () => {\n                input.style.height = 'auto';\n                input.style.height = Math.min(input.scrollHeight, 100) + 'px';\n            });\n\n            this.chatWidget.addEventListener('click', (e) => e.stopPropagation());\n        }\n\n        /**\n         * Toggles the chat widget between minimized and maximized states.\n         */\n        toggleChat() {\n            const body = this.chatWidget.querySelector('#chatBody');\n            const toggleBtn = this.chatWidget.querySelector('#toggleBtn');\n\n            if (this.isMinimized) {\n                this.chatWidget.classList.remove('minimized');\n                body.style.display = 'flex';\n                toggleBtn.textContent = '-';\n                toggleBtn.setAttribute('aria-label', 'Minimizar chat');\n                this.isMinimized = false;\n            } else {\n                this.chatWidget.classList.add('minimized');\n                body.style.display = 'none';\n                toggleBtn.textContent = '+';\n                toggleBtn.setAttribute('aria-label', 'Maximizar chat');\n                this.isMinimized = true;\n            }\n        }\n\n        /**\n         * Handles sending a message from the user to the AI assistant.\n         */\n        sendMessage() {\n            const input = this.chatWidget.querySelector('#chatInput');\n            const sendBtn = this.chatWidget.querySelector('#sendBtn');\n            if (!input || !sendBtn) return;\n\n            const messageText = input.value.trim();\n            if (!messageText || this.streaming) return;\n\n            if (messageText.length > 4000) {\n                this.addMessage('[Error] El mensaje es demasiado largo. Máximo 4000 caracteres.', 'ai');\n                return;\n            }\n\n            try {\n                this._closeCurrentStream();\n                sendBtn.disabled = true;\n\n                this.addMessage(messageText, 'user');\n                input.value = '';\n                input.style.height = 'auto';\n                this.scrollToBottom();\n                this.showTypingIndicator();\n\n                const courseId = window.courseid || this.courseId || 1;\n                if (!courseId || isNaN(courseId)) throw new Error('Course ID inválido');\n\n                const requests = Ajax.call([{\n                    methodname: \"local_datacurso_create_chat_message\",\n                    args: {\n                        courseid: parseInt(courseId, 10),\n                        message: this._sanitizeString(messageText.substring(0, 4000)),\n                        meta: JSON.stringify({\n                            user_role: this.userRole,\n                            timestamp: Math.floor(Date.now() / 1000)\n                        })\n                    },\n                }]);\n\n                requests[0].then((data) => {\n                    if (!data) throw new Error('Respuesta vacía del servidor');\n                    const streamUrl = data.stream_url;\n                    const sessionId = data.session_id;\n                    if (!streamUrl) throw new Error('URL de stream ausente en la respuesta');\n\n                    // Save session ID for cleanup\n                    this.currentSessionId = sessionId;\n\n                    this._startSSE(streamUrl, sessionId, sendBtn);\n                }).catch((err) => {\n                    this.hideTypingIndicator();\n                    this.addMessage('[Error] No se pudo iniciar el stream: ' + (err.message || 'Error desconocido'), 'ai');\n                    sendBtn.disabled = false;\n                    if (window.console) console.error('Chat error:', err);\n                    if (notification && notification.exception) notification.exception(err);\n                });\n            } catch (error) {\n                this.hideTypingIndicator();\n                this.addMessage('[Error] Error interno: ' + error.message, 'ai');\n                sendBtn.disabled = false;\n                if (window.console) console.error('Chat send error:', error);\n            }\n        }\n\n        /**\n         * Sanitizes a string by removing angle brackets.\n         * @param {string} str\n         * @returns {string}\n         */\n        _sanitizeString(str) {\n            if (typeof str !== 'string') return '';\n            return str.replace(/[<>]/g, '');\n        }\n\n        /**\n         * Ensures there is a single AI message bubble, converting typing indicator if needed.\n         * @returns {HTMLElement}\n         */\n        _ensureAIMessageEl() {\n            if (this.currentAIMessageEl) return this.currentAIMessageEl;\n\n            const messages = this.chatWidget.querySelector('#chatMessages');\n            let el = messages.querySelector('#typingIndicator');\n            if (el) {\n                // Convertir el typing en globo AI definitivo\n                el.id = ''; // ya no es indicador\n                el.classList.remove('typing-indicator');\n                el.className = 'datacurso-chat-message ai';\n                el.innerHTML = '';\n            } else {\n                el = document.createElement('div');\n                el.className = 'datacurso-chat-message ai';\n                el.textContent = '';\n                messages.appendChild(el);\n            }\n            this.currentAIMessageEl = el;\n            return el;\n        }\n\n        /**\n         * Starts SSE connection and handles incoming tokens for AI response.\n         * @param {string} streamUrl\n         * @param {string} sessionId\n         * @param {HTMLElement} sendBtn\n         */\n        _startSSE(streamUrl, sessionId, sendBtn) {\n            if (!streamUrl) {\n                this._finalizeStream(sendBtn);\n                this.addMessage('[Error] URL de stream inválida', 'ai');\n                return;\n            }\n\n            const messages = this.chatWidget.querySelector('#chatMessages');\n            if (!messages) {\n                this._finalizeStream(sendBtn);\n                return;\n            }\n\n            try {\n                const es = new EventSource(streamUrl);\n                this.currentEventSource = es;\n                this.streaming = true;\n                let firstToken = true;\n                let connectionTimeout = setTimeout(() => {\n                    if (this.streaming && firstToken) {\n                        this._appendToAIMessage('[Timeout: El servidor tardó demasiado en responder]');\n                        this._finalizeStream(sendBtn);\n                    }\n                }, 30000);\n\n                es.addEventListener('open', () => {\n                    if (window.console) console.log('SSE connection opened to Tutor-IA');\n                });\n\n                es.addEventListener('meta', () => {\n                    // Metadata event - can be logged if needed\n                });\n\n                es.addEventListener('token', (ev) => {\n                    try {\n                        if (connectionTimeout) { clearTimeout(connectionTimeout); connectionTimeout = null; }\n                        const payload = JSON.parse(ev.data);\n                        // Support both formats: 't' and 'content'\n                        const text = payload.t || payload.content || '';\n\n                        if (firstToken) {\n                            firstToken = false;\n                            // Convert typing indicator to AI message bubble\n                            this._ensureAIMessageEl();\n                            this.hideTypingIndicator();\n                        }\n                        this._appendToAIMessage(text);\n                    } catch (e) {\n                        if (window.console) console.warn('Invalid token data:', ev.data);\n                    }\n                });\n\n                es.addEventListener('message_completed', () => {\n                    if (window.console) console.log('Message completed from Tutor-IA');\n                    if (connectionTimeout) clearTimeout(connectionTimeout);\n                    this._finalizeStream(sendBtn);\n                });\n\n                es.addEventListener('error', (event) => {\n                    if (connectionTimeout) clearTimeout(connectionTimeout);\n                    if (window.console) console.error('SSE error:', event);\n                    if (!this.currentAIMessageEl || this.currentAIMessageEl.textContent.trim() === '') {\n                        this._appendToAIMessage('[Error de conexión con el servidor]');\n                    } else {\n                        this._appendToAIMessage('\\n[Conexión interrumpida]');\n                    }\n                    this._finalizeStream(sendBtn);\n                });\n\n                this.scrollToBottom();\n            } catch (error) {\n                if (window.console) console.error('Error starting SSE:', error);\n                this.addMessage('[Error] No se pudo establecer conexión SSE', 'ai');\n                this._finalizeStream(sendBtn);\n            }\n        }\n\n        /**\n         * Appends text to the current AI message bubble.\n         * @param {string} text\n         */\n        _appendToAIMessage(text) {\n            // Asegura que existe un único globo AI\n            if (!this.currentAIMessageEl) this._ensureAIMessageEl();\n            if (!this.currentAIMessageEl || typeof text !== 'string') return;\n\n            const currentText = this.currentAIMessageEl.textContent || '';\n            const maxLength = 10000;\n\n            if (currentText.length + text.length > maxLength) {\n                const remaining = maxLength - currentText.length;\n                if (remaining > 0) this.currentAIMessageEl.textContent += text.substring(0, remaining) + '...';\n                return;\n            }\n\n            this.currentAIMessageEl.textContent += text;\n            this.scrollToBottom();\n        }\n\n        /**\n         * Closes the current SSE stream and resets state.\n         */\n        _closeCurrentStream() {\n            if (this.currentEventSource) {\n                try { this.currentEventSource.close(); } catch (e) {\n                    if (window.console) console.warn('Error closing EventSource:', e);\n                }\n            }\n            this.currentEventSource = null;\n            this.streaming = false;\n            this.currentAIMessageEl = null;\n            this.hideTypingIndicator();\n        }\n\n        /**\n         * Finalizes the SSE stream and re-enables the send button.\n         * @param {HTMLElement} sendBtn\n         */\n        _finalizeStream(sendBtn) {\n            this._closeCurrentStream();\n            if (sendBtn) sendBtn.disabled = false;\n        }\n\n        /**\n         * Adds a message to the chat window.\n         * @param {string} text\n         * @param {string} type\n         */\n        addMessage(text, type) {\n            if (!text || typeof text !== 'string') return;\n\n            const messages = this.chatWidget.querySelector('#chatMessages');\n            if (!messages) return;\n\n            const messageElement = document.createElement('div');\n            messageElement.className = `datacurso-chat-message ${type}`;\n\n            const sanitizedText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');\n            messageElement.textContent = sanitizedText.substring(0, 10000);\n\n            messages.appendChild(messageElement);\n\n            const maxMessages = 100;\n            const nodes = messages.querySelectorAll('.datacurso-chat-message:not(.typing-indicator)');\n            if (nodes.length > maxMessages) {\n                for (let i = 0; i < nodes.length - maxMessages; i++) nodes[i].remove();\n            }\n\n            this.scrollToBottom();\n        }\n\n        /**\n         * Shows the typing indicator in the chat window.\n         */\n        showTypingIndicator() {\n            try {\n                const messages = this.chatWidget && this.chatWidget.querySelector('#chatMessages');\n                if (!messages) return;\n\n                // No dupliques el indicador\n                if (messages.querySelector('#typingIndicator')) return;\n\n                const typingElement = document.createElement('div');\n                typingElement.className = 'datacurso-chat-message ai typing-indicator';\n                typingElement.id = 'typingIndicator';\n                typingElement.innerHTML = '<span></span><span></span><span></span>';\n                messages.appendChild(typingElement);\n                this.scrollToBottom();\n            } catch (error) {\n                if (window.console) console.warn('Error showing typing indicator:', error);\n            }\n        }\n\n        /**\n         * Hides the typing indicator from the chat window.\n         */\n        hideTypingIndicator() {\n            try {\n                const typingIndicator = this.chatWidget && this.chatWidget.querySelector('#typingIndicator');\n                if (typingIndicator) typingIndicator.remove();\n            } catch (error) {\n                if (window.console) console.warn('Error hiding typing indicator:', error);\n            }\n        }\n\n        /**\n         * Scrolls the chat messages container to the bottom.\n         */\n        scrollToBottom() {\n            try {\n                const messages = this.chatWidget && this.chatWidget.querySelector('#chatMessages');\n                if (messages) {\n                    requestAnimationFrame(() => { messages.scrollTop = messages.scrollHeight; });\n                }\n            } catch (error) {\n                if (window.console) console.warn('Error scrolling to bottom:', error);\n            }\n        }\n\n        /**\n         * Cleanup the current chat session when user leaves the page.\n         */\n        cleanupSession() {\n            if (!this.currentSessionId) {\n                return;\n            }\n\n            // Use sendBeacon to ensure request is sent even if page is closing\n            if (navigator.sendBeacon && window.M && window.M.cfg && window.M.cfg.wwwroot) {\n                const formData = new FormData();\n                formData.append('sesskey', window.M.cfg.sesskey || '');\n                formData.append('info', 'local_datacurso_delete_chat_session');\n\n                const params = [{\n                    index: 0,\n                    methodname: 'local_datacurso_delete_chat_session',\n                    args: {sessionid: this.currentSessionId}\n                }];\n\n                formData.append('args', JSON.stringify(params));\n                navigator.sendBeacon(window.M.cfg.wwwroot + '/lib/ajax/service.php', formData);\n            }\n\n            this.currentSessionId = null;\n        }\n\n        /**\n         * Destroys the chat widget and closes any open streams.\n         */\n        destroy() {\n            this.cleanupSession();\n            this._closeCurrentStream();\n            if (this.chatWidget) {\n                this.chatWidget.remove();\n                this.chatWidget = null;\n            }\n        }\n    }\n\n    let datacursoChatInstance = null;\n\n    return {\n        init: function () {\n            if (datacursoChatInstance) datacursoChatInstance.destroy();\n            try { datacursoChatInstance = new DatacursoChat(); }\n            catch (error) { notification.exception(error); }\n        },\n        destroy: function () {\n            if (datacursoChatInstance) {\n                datacursoChatInstance.destroy();\n                datacursoChatInstance = null;\n            }\n        }\n    };\n});\n"],"names":["define","Ajax","notification","DatacursoChat","constructor","chatWidget","isMinimized","userRole","courseId","isInCourseContext","currentEventSource","currentAIMessageEl","streaming","currentSessionId","window","addEventListener","this","cleanupSession","init","checkCourseContext","detectUserRole","createChatWidget","addEventListeners","error","console","datacurso_chat_config","courseid","parseInt","url","location","href","courseMatch","match","modMatch","activityMatch","document","querySelector","courseIdElement","courseIdValue","getAttribute","isNaN","warn","userrole","role","trim","teacherElements","selector","_","userMenu","textContent","toLowerCase","includes","chatHTML","chatContainer","createElement","innerHTML","firstElementChild","body","toggleBtn","classList","add","style","display","setAttribute","appendChild","requestAnimationFrame","setTimeout","header","sendBtn","input","toggleChat","sendMessage","e","key","shiftKey","preventDefault","height","Math","min","scrollHeight","stopPropagation","remove","messageText","value","length","addMessage","_closeCurrentStream","disabled","scrollToBottom","showTypingIndicator","Error","call","methodname","args","message","_sanitizeString","substring","meta","JSON","stringify","user_role","timestamp","floor","Date","now","then","data","streamUrl","stream_url","sessionId","session_id","_startSSE","catch","err","hideTypingIndicator","exception","str","replace","_ensureAIMessageEl","messages","el","id","className","_finalizeStream","es","EventSource","firstToken","connectionTimeout","_appendToAIMessage","log","ev","clearTimeout","payload","parse","text","t","content","event","currentText","remaining","close","type","messageElement","sanitizedText","nodes","querySelectorAll","i","typingElement","typingIndicator","scrollTop","navigator","sendBeacon","M","cfg","wwwroot","formData","FormData","append","sesskey","params","index","sessionid","destroy","datacursoChatInstance"],"mappings":"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"}