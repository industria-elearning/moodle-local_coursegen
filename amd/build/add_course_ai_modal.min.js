define("local_datacurso/add_course_ai_modal",["exports","core/modal","core/templates","core/notification","core/str","local_datacurso/repository/chatbot"],(function(_exports,_modal,_templates,_notification,_str,chatbotRepository){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course AI Modal Module using Moodle's modal factory
   *
   * @module     local_datacurso/add_course_ai_modal
   * @copyright  2025 Buendata <soluciones@buendata.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal=_interopRequireDefault(_modal),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),chatbotRepository=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(chatbotRepository);let currentModal=null;_exports.init=async()=>{try{currentModal&&(currentModal.destroy(),currentModal=null);const[title,bodyHTML]=await Promise.all([(0,_str.get_string)("addcourseai_modaltitle","local_datacurso"),_templates.default.render("local_datacurso/add_course_ai_modal",{})]);currentModal=await _modal.default.create({title:title,body:bodyHTML,large:!0,scrollable:!0,removeOnClose:!0}),currentModal.getRoot().addClass("local_datacurso_course_ai_modal"),currentModal.show();const bodyEl=currentModal.getBody()[0];return initializeChatInterface(bodyEl),currentModal}catch(error){return _notification.default.exception(error),null}};const initializeChatInterface=(container,payload)=>{const messagesEl=container.querySelector(".local_datacurso_ai_messages"),form=container.querySelector("form.local_datacurso_ai_input"),textarea=form.querySelector("textarea"),sendBtn=form.querySelector(".local_datacurso_ai_send");function setFormDisabled(disabled){textarea.disabled=disabled,sendBtn.disabled=disabled;document.querySelectorAll('input[name="generate_images"]').forEach((rb=>{rb.disabled=disabled}))}(0,_str.get_string)("addcourseai_welcome","local_datacurso").then((welcomeMsg=>(pushAI(messagesEl,welcomeMsg),welcomeMsg))).catch((()=>{pushAI(messagesEl,"Hi! Tell me what course you need and I will help you create it. 😊")})),form.addEventListener("submit",(async e=>{var _document$querySelect;e.preventDefault();const prompt=textarea.value.trim();if(!prompt)return;const generateImages=(null===(_document$querySelect=document.querySelector('input[name="generate_images"]:checked'))||void 0===_document$querySelect?void 0:_document$querySelect.value)||"no";pushUser(messagesEl,prompt),textarea.value="",textarea.focus(),setFormDisabled(!0),setLoading(sendBtn,!0);const typing=pushTyping(messagesEl);try{const response=await chatbotRepository.createCourse({categoryid:payload.categoryid||1,prompt:prompt,generateimages:generateImages});if(!response.success)throw new Error(response.message||"Course creation failed");removeTyping(typing),renderWSResult(messagesEl,response),setTimeout((()=>{window.location.href=response.courseurl}),800)}catch(error){if(console.log(error),removeTyping(typing),error){const errorMsg=await(0,_str.get_string)("addcourseai_error","local_datacurso");pushAI(messagesEl,"❌ ".concat(errorMsg))}else{const successMsg=await(0,_str.get_string)("coursecreatedsuccess","local_datacurso");pushAI(messagesEl,successMsg),setTimeout((()=>{window.location.reload()}),800)}}finally{setFormDisabled(!1),setLoading(sendBtn,!1),scrollToBottom(messagesEl)}})),textarea.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),form.requestSubmit())}))},pushUser=(wrap,text)=>addBubble(wrap,text,"user"),pushAI=(wrap,text)=>addBubble(wrap,text,"ai"),addBubble=(wrap,text,role)=>{const row=document.createElement("div");row.className="local_datacurso_ai_msg ".concat(role);const bubble=document.createElement("div");bubble.className="bubble",bubble.textContent=text,row.appendChild(bubble),wrap.appendChild(row),scrollToBottom(wrap)},pushTyping=wrap=>{const row=document.createElement("div");row.className="local_datacurso_ai_msg ai local_datacurso_ai_typing";const bubble=document.createElement("div");return bubble.className="bubble",bubble.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>',row.appendChild(bubble),wrap.appendChild(row),scrollToBottom(wrap),row},removeTyping=el=>null==el?void 0:el.remove(),scrollToBottom=wrap=>{wrap.scrollTop=wrap.scrollHeight},setLoading=(btn,isLoading)=>{btn.disabled=isLoading,btn.style.opacity=isLoading?.7:1},renderWSResult=(wrap,response)=>{const lines=[];!1!==(null==response?void 0:response.success)?(null!=response&&response.message&&lines.push(response.message),lines.length?(pushAI(wrap,lines.join("\n")),setTimeout((()=>{const last=wrap.querySelector(".local_datacurso_ai_msg.ai:last-child .bubble");last&&(last.textContent=lines.join("\n"))}),50)):(0,_str.get_string)("addcourseai_done","local_datacurso").then((msg=>(pushAI(wrap,msg),msg))).catch((()=>{pushAI(wrap,"Done! The course was created successfully.")}))):null!=response&&response.message?pushAI(wrap,response.message):(0,_str.get_string)("addcourseai_faildefault","local_datacurso").then((msg=>(pushAI(wrap,msg),msg))).catch((()=>{pushAI(wrap,"It was not possible to create the course.")}))}}));

//# sourceMappingURL=add_course_ai_modal.min.js.map