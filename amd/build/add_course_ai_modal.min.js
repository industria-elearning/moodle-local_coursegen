define("local_datacurso/add_course_ai_modal",["exports","core/modal","core/templates","core/notification","core/str","local_datacurso/course_streaming","core/ajax"],(function(_exports,_modal,_templates,_notification,_str,_course_streaming,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course AI Modal Module using Moodle's modal factory
   *
   * @module     local_datacurso/add_course_ai_modal
   * @copyright  2025 Buendata <soluciones@buendata.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_modal=_interopRequireDefault(_modal),_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_ajax=_interopRequireDefault(_ajax);let currentModal=null;_exports.init=async function(){let params=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{currentModal&&(currentModal.destroy(),currentModal=null);const[title,bodyHTML]=await Promise.all([(0,_str.get_string)("addcourseai_modaltitle","local_datacurso"),_templates.default.render("local_datacurso/add_course_ai_modal",{})]);currentModal=await _modal.default.create({title:title,body:bodyHTML,large:!0,scrollable:!0,removeOnClose:!0}),currentModal.getRoot().addClass("local_datacurso_course_ai_modal"),currentModal.show();const bodyEl=currentModal.getBody()[0];return initializeChatInterface(bodyEl,params),setupPlanningButtons(bodyEl,params),currentModal}catch(error){return _notification.default.exception(error),null}};const initializeChatInterface=async(container,params)=>{try{await(0,_course_streaming.startStreaming)(params.streamingurl,container)}catch(error){console.error("Error starting streaming:",error),_notification.default.exception(error)}},addBubble=(wrap,text,role)=>{const row=document.createElement("div");row.className="local_datacurso_ai_msg ".concat(role);const bubble=document.createElement("div");bubble.className="bubble",bubble.textContent=text,row.appendChild(bubble),wrap.appendChild(row),scrollToBottom(wrap)},scrollToBottom=wrap=>{wrap.scrollTop=wrap.scrollHeight},setupPlanningButtons=(container,params)=>{const acceptBtn=container.querySelector("#accept-planning-btn"),adjustBtn=container.querySelector("#adjust-planning-btn"),chatInterface=container.querySelector("#course-chat-interface"),chatForm=container.querySelector("#course-chat-form"),chatInput=container.querySelector("#courseChatInput"),streamingContainer=container.querySelector("[data-region='local_datacurso/course_streaming']");acceptBtn&&acceptBtn.addEventListener("click",(async()=>{acceptBtn.disabled=!0,acceptBtn.textContent="Creating Course...";try{await new Promise((resolve=>setTimeout(resolve,2e3))),(0,_str.get_string)("addcourseai_done","local_datacurso").then((msg=>{_notification.default.addNotification({message:msg,type:"success"}),currentModal&&currentModal.destroy()})).catch((()=>{_notification.default.addNotification({message:"Course created successfully!",type:"success"}),currentModal&&currentModal.destroy()}))}catch(error){acceptBtn.disabled=!1,(0,_str.get_string)("accept_planning_create_course","local_datacurso").then((msg=>{acceptBtn.textContent=msg})),_notification.default.exception(error)}})),adjustBtn&&adjustBtn.addEventListener("click",(()=>{adjustBtn.disabled=!0,chatInterface&&(chatInterface.style.display="block",chatInput.focus())})),chatInput&&chatInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),chatForm&&chatForm.dispatchEvent(new Event("submit")))})),chatForm&&chatForm.addEventListener("submit",(async e=>{e.preventDefault();const message=chatInput.value.trim();if(!message)return;if(!streamingContainer)return void console.error("Streaming container not found");addBubble(streamingContainer,message,"user"),chatInput.value="";const submitBtn=chatForm.querySelector('button[type="submit"]');submitBtn.disabled=!0;try{const response=await _ajax.default.call([{methodname:"local_datacurso_plan_course_message",args:{courseid:params.courseid||0,text:message}}])[0];if(response.success&&response.data&&response.data.status){const aiResponse=document.createElement("div");aiResponse.className="mb-3 text-muted",streamingContainer.appendChild(aiResponse),await typeWriter(aiResponse,response.data.status,15)}else{const errorResponse=document.createElement("div");errorResponse.className="mb-3 text-danger",streamingContainer.appendChild(errorResponse),await typeWriter(errorResponse,response.message||"Error processing your request",15)}}catch(error){const errorResponse=document.createElement("div");errorResponse.className="mb-3 text-danger",streamingContainer.appendChild(errorResponse),await typeWriter(errorResponse,"Error: "+error.message,15),console.error("Error sending message:",error)}finally{submitBtn.disabled=!1}}))}}));

//# sourceMappingURL=add_course_ai_modal.min.js.map