define("local_datacurso/add_course_ai_modal",["exports","core/templates","core/notification","core/modal","core/str","local_datacurso/repository/chatbot"],(function(_exports,_templates,_notification,_modal,_str,_chatbot){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course AI Modal Module - Modern ES6 implementation
   *
   * @module     local_datacurso/add_course_ai_modal
   * @copyright  2025 Buendata <soluciones@buendata.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.openCourseModal=void 0,_templates=_interopRequireDefault(_templates),_notification=_interopRequireDefault(_notification),_modal=_interopRequireDefault(_modal),_chatbot=_interopRequireDefault(_chatbot);let modal=null;_exports.openCourseModal=async function(){let payload=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{modal&&(await modal.destroy(),modal=null);const bodyHTML=await _templates.default.render("local_datacurso/add_course_ai_modal",{}),title=await(0,_str.get_string)("addcourseai_modaltitle","local_datacurso");modal=await _modal.default.create({title:title,large:!0,show:!0,removeOnClose:!0}),modal.getRoot().on("hidden.bs.modal",(()=>{modal&&(modal.destroy(),modal=null)})),await modal.setBody(bodyHTML);const bodyEl=modal.getBody()[0];wireChatHandlers(bodyEl,payload)}catch(error){_notification.default.exception(error)}};const wireChatHandlers=(container,payload)=>{const messagesEl=container.querySelector(".bdai-messages"),form=container.querySelector("form.bdai-input"),textarea=form.querySelector("textarea"),sendBtn=form.querySelector(".bdai-send");function setFormDisabled(disabled){textarea.disabled=disabled,sendBtn.disabled=disabled;document.querySelectorAll('input[name="generate_images"]').forEach((rb=>{rb.disabled=disabled}))}(0,_str.get_string)("addcourseai_welcome","local_datacurso").then((welcomeMsg=>(pushAI(messagesEl,welcomeMsg),welcomeMsg))).catch((()=>{pushAI(messagesEl,"Hi! Tell me what course you need and I will help you create it. 😊")})),form.addEventListener("submit",(async e=>{var _document$querySelect;e.preventDefault();const prompt=textarea.value.trim();if(!prompt)return;const generateImages=(null===(_document$querySelect=document.querySelector('input[name="generate_images"]:checked'))||void 0===_document$querySelect?void 0:_document$querySelect.value)||"no";pushUser(messagesEl,prompt),textarea.value="",textarea.focus(),setFormDisabled(!0),setLoading(sendBtn,!0);const typing=pushTyping(messagesEl);try{const response=await _chatbot.default.createCourse({...payload,prompt:prompt,generateimages:generateImages});if(!response.ok)throw new Error(response.message);removeTyping(typing),renderWSResult(messagesEl,response),setTimeout((()=>{window.location.reload()}),800)}catch(error){if(removeTyping(typing),error){const errorMsg=await(0,_str.get_string)("addcourseai_error","local_datacurso");pushAI(messagesEl,"❌ ".concat(errorMsg))}else{const successMsg=await(0,_str.get_string)("coursecreatedsuccess","local_datacurso");pushAI(messagesEl,successMsg),setTimeout((()=>{window.location.reload()}),800)}}finally{setFormDisabled(!1),setLoading(sendBtn,!1),scrollToBottom(messagesEl)}})),textarea.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),form.requestSubmit())}))},pushUser=(wrap,text)=>addBubble(wrap,text,"user"),pushAI=(wrap,text)=>addBubble(wrap,text,"ai"),addBubble=(wrap,text,role)=>{const row=document.createElement("div");row.className="bdai-msg ".concat(role);const bubble=document.createElement("div");bubble.className="bubble",bubble.textContent=text,row.appendChild(bubble),wrap.appendChild(row),scrollToBottom(wrap)},pushTyping=wrap=>{const row=document.createElement("div");row.className="bdai-msg ai bdai-typing";const bubble=document.createElement("div");return bubble.className="bubble",bubble.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>',row.appendChild(bubble),wrap.appendChild(row),scrollToBottom(wrap),row},removeTyping=el=>null==el?void 0:el.remove(),scrollToBottom=wrap=>{wrap.scrollTop=wrap.scrollHeight},setLoading=(btn,isLoading)=>{btn.disabled=isLoading,btn.style.opacity=isLoading?.7:1},renderWSResult=(wrap,response)=>{const lines=[];!1!==(null==response?void 0:response.success)?(null!=response&&response.message&&lines.push(response.message),lines.length?(pushAI(wrap,lines.join("\n")),setTimeout((()=>{const last=wrap.querySelector(".bdai-msg.ai:last-child .bubble");last&&(last.textContent=lines.join("\n"))}),50)):(0,_str.get_string)("addcourseai_done","local_datacurso").then((msg=>(pushAI(wrap,msg),msg))).catch((()=>{pushAI(wrap,"Done! The course was created successfully.")}))):null!=response&&response.message?pushAI(wrap,response.message):(0,_str.get_string)("addcourseai_faildefault","local_datacurso").then((msg=>(pushAI(wrap,msg),msg))).catch((()=>{pushAI(wrap,"It was not possible to create the course.")}))}}));

//# sourceMappingURL=add_course_ai_modal.min.js.map