{"version":3,"file":"add_module_ai_modal.min.js","sources":["../src/add_module_ai_modal.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module AI Modal Module using Moodle's modal factory\n *\n * @module     local_datacurso/add_module_ai_modal\n * @copyright  2025 Buendata <soluciones@buendata.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Modal from 'core/modal';\nimport Templates from 'core/templates';\nimport Notification from 'core/notification';\nimport {get_string} from 'core/str';\nimport {startModuleStreaming} from 'local_datacurso/module_streaming';\nimport Ajax from 'core/ajax';\n\nlet currentModal = null;\n\n/**\n * Initialize and show the module AI modal\n * @param {Object} params - Parameters object\n * @param {number} params.courseid - Course ID\n * @param {number} params.sectionnum - Section number (optional)\n * @param {number} params.beforemod - Before module ID (optional)\n * @returns {Promise}\n */\nexport const init = async(params = {}) => {\n    try {\n        // Close existing modal if open\n        if (currentModal) {\n            currentModal.destroy();\n            currentModal = null;\n        }\n\n        // Get modal title and body content\n        const [title, bodyHTML] = await Promise.all([\n            get_string('addmoduleai_modaltitle', 'local_datacurso'),\n            Templates.render('local_datacurso/add_module_ai_modal', {})\n        ]);\n\n        // Create modal using modern Modal class\n        currentModal = await Modal.create({\n            title: title,\n            body: bodyHTML,\n            large: true,\n            scrollable: true,\n            removeOnClose: true\n        });\n\n        currentModal.getRoot().addClass('local_datacurso_module_ai_modal');\n\n        currentModal.show();\n\n        const bodyEl = currentModal.getBody()[0];\n        initializeModuleForm(bodyEl, params);\n        return currentModal;\n\n    } catch (error) {\n        Notification.exception(error);\n        return null;\n    }\n};\n\n/**\n * Initialize the module creation form\n * @param {Element} container - The modal container element\n * @param {Object} params - The parameters including course ID\n */\nconst initializeModuleForm = async (container, params) => {\n    const form = container.querySelector('#module-creation-form');\n    const promptInput = container.querySelector('#modulePromptInput');\n    const generateImagesCheckbox = container.querySelector('#generateImagesCheckbox');\n    const submitBtn = container.querySelector('#create-module-btn');\n    const streamingContainer = container.querySelector('#module-streaming-container');\n\n    if (form && promptInput && submitBtn) {\n        // Focus on the prompt input\n        promptInput.focus();\n\n        // Add Enter key support for prompt input\n        promptInput.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter' && !e.shiftKey) {\n                e.preventDefault();\n                form.dispatchEvent(new Event('submit'));\n            }\n        });\n\n        form.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            \n            const prompt = promptInput.value.trim();\n            if (!prompt) {\n                promptInput.focus();\n                return;\n            }\n\n            // Disable form while processing\n            submitBtn.disabled = true;\n            const originalText = submitBtn.textContent;\n            submitBtn.textContent = await get_string('creating_module', 'local_datacurso');\n            \n            // Hide form and show streaming container\n            form.style.display = 'none';\n            streamingContainer.style.display = 'block';\n\n            try {\n                // Call the create_mod_stream webservice\n                const response = await Ajax.call([{\n                    methodname: 'local_datacurso_create_mod_stream',\n                    args: {\n                        courseid: params.courseid,\n                        sectionnum: params.sectionnum || null,\n                        prompt: prompt,\n                        generateimages: generateImagesCheckbox && generateImagesCheckbox.checked ? 1 : 0,\n                        beforemod: params.beforemod || null\n                    }\n                }])[0];\n                \n                if (!response.ok) {\n                    throw new Error(response.message || await get_string('error_creating_module', 'local_datacurso'));\n                }\n\n                // Build streaming URL\n                const baseurl = M.cfg.wwwroot.replace(/\\/$/, '');\n                const streamingUrl = `${baseurl}/local/datacurso/streaming_proxy.php?endpoint=resources/create-mod/stream&job_id=${response.job_id}`;\n\n                // Create streaming block template\n                const html = await Templates.render('local_datacurso/module_streaming_inline', {\n                    title: await get_string('module_creating_title', 'local_datacurso'),\n                    subtitle: await get_string('module_creating_subtitle', 'local_datacurso')\n                });\n                streamingContainer.innerHTML = html;\n\n                // Start streaming\n                await startModuleStreaming(streamingUrl, streamingContainer);\n                \n            } catch (error) {\n                console.error('Error creating module:', error);\n                \n                // Show form again and restore button\n                form.style.display = 'block';\n                streamingContainer.style.display = 'none';\n                submitBtn.disabled = false;\n                submitBtn.textContent = originalText;\n                \n                Notification.exception(error);\n            }\n        });\n    }\n};\n"],"names":["currentModal","async","params","destroy","title","bodyHTML","Promise","all","Templates","render","Modal","create","body","large","scrollable","removeOnClose","getRoot","addClass","show","bodyEl","getBody","initializeModuleForm","error","exception","container","form","querySelector","promptInput","generateImagesCheckbox","submitBtn","streamingContainer","focus","addEventListener","e","key","shiftKey","preventDefault","dispatchEvent","Event","prompt","value","trim","disabled","originalText","textContent","style","display","response","Ajax","call","methodname","args","courseid","sectionnum","generateimages","checked","beforemod","ok","Error","message","baseurl","M","cfg","wwwroot","replace","streamingUrl","job_id","html","subtitle","innerHTML","console"],"mappings":";;;;;;;kQA+BIA,aAAe,mBAUCC,qBAAMC,8DAAS,OAGvBF,eACAA,aAAaG,UACbH,aAAe,YAIZI,MAAOC,gBAAkBC,QAAQC,IAAI,EACxC,mBAAW,yBAA0B,mBACrCC,mBAAUC,OAAO,sCAAuC,MAI5DT,mBAAqBU,eAAMC,OAAO,CAC9BP,MAAOA,MACPQ,KAAMP,SACNQ,OAAO,EACPC,YAAY,EACZC,eAAe,IAGnBf,aAAagB,UAAUC,SAAS,mCAEhCjB,aAAakB,aAEPC,OAASnB,aAAaoB,UAAU,UACtCC,qBAAqBF,OAAQjB,QACtBF,aAET,MAAOsB,oCACQC,UAAUD,OAChB,aASTD,qBAAuBpB,MAAOuB,UAAWtB,gBACrCuB,KAAOD,UAAUE,cAAc,yBAC/BC,YAAcH,UAAUE,cAAc,sBACtCE,uBAAyBJ,UAAUE,cAAc,2BACjDG,UAAYL,UAAUE,cAAc,sBACpCI,mBAAqBN,UAAUE,cAAc,+BAE/CD,MAAQE,aAAeE,YAEvBF,YAAYI,QAGZJ,YAAYK,iBAAiB,WAAYC,IACvB,UAAVA,EAAEC,KAAoBD,EAAEE,WACxBF,EAAEG,iBACFX,KAAKY,cAAc,IAAIC,MAAM,eAIrCb,KAAKO,iBAAiB,UAAU/B,MAAAA,IAC5BgC,EAAEG,uBAEIG,OAASZ,YAAYa,MAAMC,WAC5BF,mBACDZ,YAAYI,QAKhBF,UAAUa,UAAW,QACfC,aAAed,UAAUe,YAC/Bf,UAAUe,kBAAoB,mBAAW,kBAAmB,mBAG5DnB,KAAKoB,MAAMC,QAAU,OACrBhB,mBAAmBe,MAAMC,QAAU,kBAIzBC,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,oCACZC,KAAM,CACFC,SAAUlD,OAAOkD,SACjBC,WAAYnD,OAAOmD,YAAc,KACjCd,OAAQA,OACRe,eAAgB1B,wBAA0BA,uBAAuB2B,QAAU,EAAI,EAC/EC,UAAWtD,OAAOsD,WAAa,SAEnC,OAECT,SAASU,SACJ,IAAIC,MAAMX,SAASY,eAAiB,mBAAW,wBAAyB,0BAI5EC,QAAUC,EAAEC,IAAIC,QAAQC,QAAQ,MAAO,IACvCC,uBAAkBL,oGAA2Fb,SAASmB,QAGtHC,WAAa3D,mBAAUC,OAAO,0CAA2C,CAC3EL,YAAa,mBAAW,wBAAyB,mBACjDgE,eAAgB,mBAAW,2BAA4B,qBAE3DtC,mBAAmBuC,UAAYF,WAGzB,0CAAqBF,aAAcnC,oBAE3C,MAAOR,OACLgD,QAAQhD,MAAM,yBAA0BA,OAGxCG,KAAKoB,MAAMC,QAAU,QACrBhB,mBAAmBe,MAAMC,QAAU,OACnCjB,UAAUa,UAAW,EACrBb,UAAUe,YAAcD,mCAEXpB,UAAUD"}