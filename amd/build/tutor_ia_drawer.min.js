/**
 * Tutor-IA Drawer - Drawer lateral para chat con IA
 *
 * @module     local_datacurso/tutor_ia_drawer
 * @copyright  2025 Datacurso
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_datacurso/tutor_ia_drawer",["jquery","core/ajax","core/notification","core/drawer","core/pubsub","core/custom_interaction_events","core/modal_backdrop","core/templates","core/local/aria/focuslock"],(function($,Ajax,Notification,Drawer,PubSub,CustomEvents,ModalBackdrop,Templates,FocusLock){const SELECTORS_MESSAGES='[data-region="tutor-ia-messages"]',SELECTORS_INPUT='[data-region="tutor-ia-input"]',SELECTORS_SEND_BTN='[data-action="send-message"]',SELECTORS_CLOSE_BTN='[data-action="close-drawer"]',SELECTORS_TRIGGER='[data-action="toggle-tutor-ia-drawer"]',EVENTS_SHOW="local_datacurso/tutor_ia_drawer/show",EVENTS_HIDE="local_datacurso/tutor_ia_drawer/hide",EVENTS_TOGGLE="local_datacurso/tutor_ia_drawer/toggle";class TutorIADrawer{constructor(root,uniqueId,courseId,userId){this.root=$(root),this.uniqueId=uniqueId,this.courseId=courseId,this.userId=userId,this.drawerRoot=null,this.backdrop=null,this.streaming=!1,this.currentEventSource=null,this.currentSessionId=null,this.currentAIMessageEl=null,this.init()}init(){this.drawerRoot=Drawer.getDrawerRoot(this.root),this.drawerRoot.length?(this.setupBackdrop(),this.registerEventListeners(),this.registerTrigger(),window.addEventListener("beforeunload",(()=>this.cleanup()))):window.console.error("Tutor-IA: No se encontró drawer root")}setupBackdrop(){Templates.render("core/modal_backdrop",{}).then((html=>{this.backdrop=new ModalBackdrop(html);const zIndex=window.getComputedStyle(this.drawerRoot[0]).zIndex;return zIndex&&this.backdrop.setZIndex(zIndex-1),this.backdrop.getAttachmentPoint().get(0).addEventListener("click",(()=>{this.hide()})),this.backdrop})).catch(Notification.exception)}registerEventListeners(){this.root.find(SELECTORS_CLOSE_BTN).on("click",(e=>{e.preventDefault(),this.hide()})),this.root.find(SELECTORS_SEND_BTN).on("click",(()=>{this.sendMessage()}));const input=this.root.find(SELECTORS_INPUT);input.on("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),input.on("input",(function(){this.style.height="auto",this.style.height=Math.min(this.scrollHeight,120)+"px"})),PubSub.subscribe(EVENTS_SHOW,(()=>this.show())),PubSub.subscribe(EVENTS_HIDE,(()=>this.hide())),PubSub.subscribe(EVENTS_TOGGLE,(()=>this.toggle())),PubSub.subscribe("core_message/show",(()=>{Drawer.isVisible(this.drawerRoot)&&this.hide()}))}registerTrigger(){const trigger=$(SELECTORS_TRIGGER);trigger.length&&(CustomEvents.define(trigger,[CustomEvents.events.activate]),trigger.on(CustomEvents.events.activate,(e=>{e.preventDefault(),this.toggle()})))}show(){if(this.drawerRoot.length){if(PubSub.publish("core_message/hide",{}),this.backdrop){this.backdrop.show();const pageWrapper=document.getElementById("page");pageWrapper&&(pageWrapper.style.overflow="hidden")}Drawer.show(this.drawerRoot),FocusLock.trapFocus(this.root[0]),$(SELECTORS_TRIGGER).attr("aria-expanded","true"),$("body").addClass("tutor-ia-drawer-open"),this.root.find(SELECTORS_CLOSE_BTN).focus()}}hide(){if(this.drawerRoot.length){if(this.backdrop){this.backdrop.hide();const pageWrapper=document.getElementById("page");pageWrapper&&(pageWrapper.style.overflow="visible")}Drawer.hide(this.drawerRoot),FocusLock.untrapFocus(),$(SELECTORS_TRIGGER).attr("aria-expanded","false").focus(),$("body").removeClass("tutor-ia-drawer-open")}}toggle(){Drawer.isVisible(this.drawerRoot)?this.hide():this.show()}sendMessage(){const input=this.root.find(SELECTORS_INPUT),sendBtn=this.root.find(SELECTORS_SEND_BTN),messageText=input.val().trim();if(messageText&&!this.streaming)if(messageText.length>4e3)this.addMessage("[Error] El mensaje es demasiado largo. Máximo 4000 caracteres.","ai");else try{this.closeCurrentStream(),sendBtn.prop("disabled",!0),this.addMessage(messageText,"user"),input.val(""),input.css("height","auto"),this.scrollToBottom(),this.showTypingIndicator();Ajax.call([{methodname:"local_datacurso_create_chat_message",args:{courseid:parseInt(this.courseId,10),message:this.sanitizeString(messageText.substring(0,4e3)),meta:JSON.stringify({user_role:"Estudiante",timestamp:Math.floor(Date.now()/1e3)})}}])[0].then((data=>{if(!data||!data.stream_url)throw new Error("URL de stream ausente en la respuesta");this.currentSessionId=data.session_id,this.startSSE(data.stream_url,sendBtn)})).catch((err=>{this.hideTypingIndicator(),this.addMessage("[Error] "+(err.message||"Error desconocido"),"ai"),sendBtn.prop("disabled",!1),Notification.exception(err)}))}catch(error){this.hideTypingIndicator(),this.addMessage("[Error] Error interno: "+error.message,"ai"),sendBtn.prop("disabled",!1)}}startSSE(streamUrl,sendBtn){try{const es=new EventSource(streamUrl);this.currentEventSource=es,this.streaming=!0;let firstToken=!0;const connectionTimeout=setTimeout((()=>{this.streaming&&firstToken&&(this.appendToAIMessage("[Timeout: El servidor tardó demasiado en responder]"),this.finalizeStream(sendBtn))}),3e4);es.addEventListener("open",(()=>{window.console.log("SSE connection opened to Tutor-IA")})),es.addEventListener("meta",(()=>{})),es.addEventListener("token",(ev=>{try{connectionTimeout&&clearTimeout(connectionTimeout);const payload=JSON.parse(ev.data),text=payload.t||payload.content||"";firstToken&&(firstToken=!1,this.ensureAIMessageEl(),this.hideTypingIndicator()),this.appendToAIMessage(text)}catch(e){window.console.warn("Invalid token data:",ev.data)}})),es.addEventListener("message_completed",(()=>{window.console.log("Message completed from Tutor-IA"),connectionTimeout&&clearTimeout(connectionTimeout),this.finalizeStream(sendBtn)})),es.addEventListener("error",(()=>{connectionTimeout&&clearTimeout(connectionTimeout),window.console.error("SSE error"),this.currentAIMessageEl&&""!==this.currentAIMessageEl.textContent.trim()?this.appendToAIMessage("\n[Conexión interrumpida]"):this.appendToAIMessage("[Error de conexión con el servidor]"),this.finalizeStream(sendBtn)}))}catch(error){window.console.error("Error starting SSE:",error),this.addMessage("[Error] No se pudo establecer conexión SSE","ai"),this.finalizeStream(sendBtn)}}ensureAIMessageEl(){if(this.currentAIMessageEl)return this.currentAIMessageEl;const messages=this.root.find(SELECTORS_MESSAGES);let el=messages.find(".tutor-ia-typing");return el.length?(el.removeClass("tutor-ia-typing"),el.addClass("tutor-ia-message ai"),el.html("")):(el=$('<div class="tutor-ia-message ai"></div>'),messages.append(el)),this.currentAIMessageEl=el[0],this.currentAIMessageEl}appendToAIMessage(text){if(this.currentAIMessageEl||this.ensureAIMessageEl(),!this.currentAIMessageEl||"string"!=typeof text)return;const currentText=this.currentAIMessageEl.textContent||"";if(currentText.length+text.length>1e4){const remaining=1e4-currentText.length;remaining>0&&(this.currentAIMessageEl.textContent+=text.substring(0,remaining)+"...")}else this.currentAIMessageEl.textContent+=text,this.scrollToBottom()}addMessage(text,type){if(!text||"string"!=typeof text)return;const messages=this.root.find(SELECTORS_MESSAGES),messageEl=$("<div></div>").addClass("tutor-ia-message").addClass(type).text(text.substring(0,1e4));messages.append(messageEl),this.scrollToBottom()}showTypingIndicator(){const messages=this.root.find(SELECTORS_MESSAGES);if(messages.find(".tutor-ia-typing").length)return;const typing=$('<div class="tutor-ia-message ai tutor-ia-typing"></div>').html('<span class="dot"></span><span class="dot"></span><span class="dot"></span>');messages.append(typing),this.scrollToBottom()}hideTypingIndicator(){this.root.find(".tutor-ia-typing").remove()}scrollToBottom(){const messages=this.root.find(SELECTORS_MESSAGES);messages.length&&messages[0]&&messages.scrollTop(messages[0].scrollHeight)}closeCurrentStream(){if(this.currentEventSource)try{this.currentEventSource.close()}catch(e){window.console.warn("Error closing EventSource:",e)}this.currentEventSource=null,this.streaming=!1,this.currentAIMessageEl=null,this.hideTypingIndicator()}finalizeStream(sendBtn){this.closeCurrentStream(),sendBtn&&sendBtn.prop("disabled",!1)}sanitizeString(str){return"string"!=typeof str?"":str.replace(/[<>]/g,"")}cleanup(){if(this.closeCurrentStream(),this.currentSessionId&&navigator.sendBeacon&&window.M&&window.M.cfg&&window.M.cfg.wwwroot){const formData=new FormData;formData.append("sesskey",window.M.cfg.sesskey||""),formData.append("info","local_datacurso_delete_chat_session");const params=[{index:0,methodname:"local_datacurso_delete_chat_session",args:{sessionid:this.currentSessionId}}];formData.append("args",JSON.stringify(params)),navigator.sendBeacon(window.M.cfg.wwwroot+"/lib/ajax/service.php",formData)}this.currentSessionId=null}destroy(){this.cleanup(),FocusLock.untrapFocus(),this.backdrop&&this.backdrop.hide()}}return{init:function(root,uniqueId,courseId,userId){return new TutorIADrawer(root,uniqueId,courseId,userId)}}}));

//# sourceMappingURL=tutor_ia_drawer.min.js.map