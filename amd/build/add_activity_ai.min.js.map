{"version":3,"file":"add_activity_ai.min.js","sources":["../src/add_activity_ai.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module add_activity_ai\n *\n * @module     local_datacurso/add_activity_ai\n * @copyright  2025 Buendata <soluciones@buendata.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n  \"core/templates\",\n  \"core/notification\",\n  \"core/modal\",\n  \"core/custom_interaction_events\",\n  \"core/str\",\n  \"local_datacurso/repository/chatbot\",\n  \"local_datacurso/module_streaming\",\n], (Templates, Notification, Modal, CustomEvents, Str, chatbotRepository, moduleStreaming) => {\n  const LINK_SELECTOR = '[data-action=\"local_datacurso/add_activity_ai\"]';\n\n  let modal = null;\n  let initialized = false;\n  \n  // Global state for scroll behavior\n  let userHasScrolled = false;\n  let scrollTimeout = null;\n  \n  /**\n   * Check if user is at the bottom of the scrollable container\n   * @param {Element} element - The scrollable element\n   * @returns {boolean} - True if user is at bottom\n   */\n  const isAtBottom = (element) => {\n    const threshold = 50; // 50px threshold\n    return element.scrollTop + element.clientHeight >= element.scrollHeight - threshold;\n  };\n  \n  /**\n   * Setup scroll detection to pause auto-scroll when user scrolls manually\n   * @param {Element} scrollContainer - The container to monitor for scroll\n   */\n  const setupScrollDetection = (scrollContainer) => {\n    if (!scrollContainer) return;\n    \n    const handleScroll = () => {\n      // Clear existing timeout\n      if (scrollTimeout) {\n        clearTimeout(scrollTimeout);\n      }\n      \n      // Mark that user has scrolled\n      userHasScrolled = true;\n      \n      // Check if user scrolled back to bottom\n      if (isAtBottom(scrollContainer)) {\n        // Reset flag after a short delay to resume auto-scroll\n        scrollTimeout = setTimeout(() => {\n          userHasScrolled = false;\n        }, 1000);\n      }\n    };\n    \n    scrollContainer.addEventListener('scroll', handleScroll, { passive: true });\n  };\n\n  const init = () => {\n    if (initialized) {\n      return;\n    }\n    initialized = true;\n\n    const events = [\n      \"click\",\n      CustomEvents.events.activate,\n      CustomEvents.events.keyboardActivate,\n    ];\n\n    CustomEvents.define(document, events);\n\n    events.forEach((event) => {\n      document.addEventListener(event, async (e) => {\n        const link = e.target.closest(LINK_SELECTOR);\n        if (!link) {\n          return;\n        }\n        e.preventDefault();\n        const payload = readDataset(link);\n        await openChatModal(payload);\n      });\n    });\n  };\n\n  const readDataset = (el) => {\n    const { sectionnum, beforemod } = el.dataset;\n    return {\n      sectionnum: Number(sectionnum),\n      beforemod: beforemod ? Number(beforemod) : null,\n    };\n  };\n\n  const openChatModal = async (payload) => {\n    try {\n      // Si ya hay un modal abierto, cerrarlo primero\n      if (modal) {\n        await modal.destroy();\n        modal = null;\n      }\n\n      const [bodyHTML, footerHTML] = await Promise.all([\n        Templates.render(\"local_datacurso/add_activity_ai_modal\", {}),\n        Templates.render(\"local_datacurso/activity_chat_footer\", {})\n      ]);\n\n      const title = await Str.get_string(\n        \"addactivityai_modaltitle\",\n        \"local_datacurso\"\n      );\n\n      modal = await Modal.create({\n        title,\n        body: bodyHTML,\n        footer: footerHTML,\n        large: true,\n        scrollable: true,\n        removeOnClose: true,\n      });\n\n      // Align width/appearance with course AI modal.\n      modal.getRoot().addClass('local_datacurso_course_ai_modal');\n\n      // Explicitly show after creation (no show: true in options).\n      modal.show();\n\n      // Manejar el evento de cierre del modal\n      modal.getRoot().on(\"hidden.bs.modal\", () => {\n        if (modal) {\n          modal.destroy();\n          modal = null;\n        }\n      });\n      // Reset scroll state and setup detection\n      userHasScrolled = false;\n      if (scrollTimeout) {\n        clearTimeout(scrollTimeout);\n        scrollTimeout = null;\n      }\n      \n      // Setup scroll detection on modal body\n      const modalBody = modal.getBody()[0];\n      if (modalBody) {\n        setupScrollDetection(modalBody);\n      }\n      \n      // Handlers del chat\n      const bodyEl = modal.getBody()[0];\n      const footerEl = modal.getFooter()[0];\n      wireChatHandlers(bodyEl, footerEl, payload);\n    } catch (err) {\n      Notification.exception(err);\n    }\n  };\n\n  const wireChatHandlers = (container, footerContainer, payload) => {\n    const streamingSection = container.querySelector(\"#activity-streaming-section\");\n    const userMessagesSection = container.querySelector(\"#activity-user-messages\");\n    const form = footerContainer.querySelector(\"form.local_datacurso_ai_input\");\n    const textarea = form.querySelector(\"textarea\");\n    const sendBtn = form.querySelector(\".local_datacurso_ai_send\");\n\n    // Enviar con submit.\n    form.addEventListener(\"submit\", async (e) => {\n      e.preventDefault();\n      const prompt = textarea.value.trim();\n      if (!prompt) return;\n\n      pushUser(userMessagesSection, prompt);\n      \n      // Show user messages section\n      if (userMessagesSection) {\n        userMessagesSection.style.display = \"block\";\n      }\n\n      const generateImages = document.querySelector('input[name=\"generate_images\"]:checked').value;\n\n      textarea.value = \"\";\n\n      // Disable form elements\n      sendBtn.disabled = true;\n      textarea.disabled = true;\n      const radioButtons = document.querySelectorAll('input[name=\"generate_images\"]');\n      radioButtons.forEach((rb) => {\n        rb.disabled = true;\n      });\n      setLoading(sendBtn, true);\n\n      try {\n        // Start streaming job\n        const response = await chatbotRepository.createModStream({\n          ...payload,\n          prompt,\n          generateimages: generateImages\n        });\n\n        if (!response.ok) {\n          throw new Error(response.message);\n        }\n\n        // Show and use the integrated streaming section\n        if (streamingSection) {\n          streamingSection.style.display = \"block\";\n          \n          // Update progress indicator text for activity creation\n          const progressIndicator = streamingSection.querySelector(\"[data-region='local_datacurso/course_streaming/progress']\");\n          if (progressIndicator) {\n            const titleElement = progressIndicator.querySelector(\"h6, h5\");\n            const subtitleElement = progressIndicator.querySelector(\"small\");\n            if (titleElement) {\n              const titleText = await Str.get_string('module_creation_title', 'local_datacurso');\n              titleElement.textContent = titleText;\n            }\n            if (subtitleElement) {\n              const subtitleText = await Str.get_string('module_creation_subtitle', 'local_datacurso');\n              subtitleElement.textContent = subtitleText;\n            }\n            progressIndicator.style.display = \"block\";\n          }\n        }\n\n        // Start module streaming using the integrated container\n        await moduleStreaming.startModuleStreaming(\n          response.streamingurl, \n          streamingSection, \n          {\n            courseid: payload.courseid,\n            sectionnum: payload.sectionnum,\n            beforemod: payload.beforemod,\n            jobid: response.job_id\n          }\n        );\n\n      } catch (err) {\n        console.error(\"Error starting module creation:\", err);\n        \n        // Show error message in streaming section\n        if (streamingSection) {\n          streamingSection.style.display = \"block\";\n          const eventList = streamingSection.querySelector(\"[data-region='local_datacurso/course_streaming']\");\n          if (eventList) {\n            const errorDiv = document.createElement(\"div\");\n            errorDiv.className = \"alert alert-danger mb-2\";\n            const errorMsg = err.message || await Str.get_string(\"addactivityai_error\", \"local_datacurso\");\n            errorDiv.innerHTML = `<small>❌ Error: ${errorMsg}</small>`;\n            eventList.appendChild(errorDiv);\n            \n            // Auto-scroll to show error message - only if user hasn't scrolled\n            if (!userHasScrolled) {\n              const modalBody = document.querySelector('.modal-body');\n              if (modalBody) {\n                modalBody.scrollTop = modalBody.scrollHeight;\n              } else {\n                eventList.scrollTop = eventList.scrollHeight;\n              }\n            }\n          }\n        }\n      } finally {\n        // Re-enable form elements\n        radioButtons.forEach((rb) => {\n          rb.disabled = false;\n        });\n        textarea.disabled = false;\n        sendBtn.disabled = false;\n        setLoading(sendBtn, false);\n      }\n    });\n\n    // Enter para enviar (sin Ctrl, ya que es más común en chat)\n    textarea.addEventListener(\"keydown\", (e) => {\n      if (e.key === \"Enter\" && !e.shiftKey) {\n        e.preventDefault();\n        form.requestSubmit();\n      }\n    });\n  };\n\n  const pushUser = (wrap, text) => addBubble(wrap, text, \"user\");\n  const pushAI = (wrap, text) => addBubble(wrap, text, \"ai\");\n\n  const addBubble = (wrap, text, role) => {\n    const row = document.createElement(\"div\");\n    row.className = `local_datacurso_ai_msg ${role}`;\n    const b = document.createElement(\"div\");\n    b.className = \"bubble\";\n    b.textContent = text;\n    row.appendChild(b);\n    wrap.appendChild(row);\n    scrollToBottom(wrap);\n  };\n\n  const scrollToBottom = (wrap) => {\n    if (!userHasScrolled) {\n      const modalBody = document.querySelector('.modal-body');\n      if (modalBody) {\n        modalBody.scrollTop = modalBody.scrollHeight;\n      } else {\n        wrap.scrollTop = wrap.scrollHeight;\n      }\n    }\n  };\n\n  const setLoading = (btn, isLoading) => {\n    btn.disabled = isLoading;\n    btn.style.opacity = isLoading ? 0.7 : 1;\n  };\n\n  const renderWSResult = (wrap, res) => {\n    const lines = [];\n    if (res?.success === false) {\n      if (res?.message) {\n        pushAI(wrap, res.message);\n      } else {\n        Str.get_string(\"addactivityai_faildefault\", \"local_datacurso\").then(\n          (s) => pushAI(wrap, s)\n        );\n      }\n      return;\n    }\n\n    if (res?.message) lines.push(res.message);\n\n    if (lines.length) {\n      pushAI(wrap, lines.join(\"\\n\"));\n      setTimeout(() => {\n        const last = wrap.querySelector(\".local_datacurso_ai_msg.ai:last-child .bubble\");\n        if (last) last.textContent = lines.join(\"\\n\");\n      }, 50);\n    } else {\n      Str.get_string(\"addactivityai_done\", \"local_datacurso\").then((s) =>\n        pushAI(wrap, s)\n      );\n    }\n  };\n\n  return { init, openChatModal };\n});\n"],"names":["define","Templates","Notification","Modal","CustomEvents","Str","chatbotRepository","moduleStreaming","modal","initialized","userHasScrolled","scrollTimeout","readDataset","el","sectionnum","beforemod","dataset","Number","openChatModal","async","destroy","bodyHTML","footerHTML","Promise","all","render","title","get_string","create","body","footer","large","scrollable","removeOnClose","getRoot","addClass","show","on","clearTimeout","modalBody","getBody","scrollContainer","addEventListener","element","scrollTop","clientHeight","scrollHeight","setTimeout","passive","setupScrollDetection","bodyEl","footerEl","getFooter","wireChatHandlers","payload","err","exception","container","footerContainer","streamingSection","querySelector","userMessagesSection","form","textarea","sendBtn","e","preventDefault","prompt","value","trim","pushUser","style","display","generateImages","document","disabled","radioButtons","querySelectorAll","forEach","rb","setLoading","response","createModStream","generateimages","ok","Error","message","progressIndicator","titleElement","subtitleElement","titleText","textContent","subtitleText","startModuleStreaming","streamingurl","courseid","jobid","job_id","console","error","eventList","errorDiv","createElement","className","errorMsg","innerHTML","appendChild","key","shiftKey","requestSubmit","wrap","text","addBubble","role","row","b","scrollToBottom","btn","isLoading","opacity","init","events","activate","keyboardActivate","event","link","target","closest"],"mappings":"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"}