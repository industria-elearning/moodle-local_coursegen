{"version":3,"file":"add_activity_ai.min.js","sources":["../src/add_activity_ai.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * TODO describe module add_activity_ai\n *\n * @module     local_datacurso/add_activity_ai\n * @copyright  2025 Buendata <soluciones@buendata.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n  'core/templates',\n  'core/notification',\n  'core/modal',\n  'core/custom_interaction_events',\n  'core/str',\n  'local_datacurso/repository/chatbot'\n], (Templates, Notification, Modal, CustomEvents, Str, chatbotRepository) => {\n\n  const LINK_SELECTOR = '[data-action=\"local_datacurso/add_activity_ai\"]';\n\n  let modal = null;\n  let initialized = false;\n\n  const init = () => {\n    if (initialized) {\n      return;\n    }\n    initialized = true;\n\n    const events = [\n      'click',\n      CustomEvents.events.activate,\n      CustomEvents.events.keyboardActivate,\n    ];\n\n    CustomEvents.define(document, events);\n\n    events.forEach((event) => {\n      document.addEventListener(event, async (e) => {\n        const link = e.target.closest(LINK_SELECTOR);\n        if (!link) {\n          return;\n        }\n        e.preventDefault();\n        const payload = readDataset(link);\n        await openChatModal(payload);\n      });\n    });\n  };\n\n  const readDataset = (el) => {\n    const { courseid, sectionid, sectionnum, beforemod } = el.dataset;\n    return {\n      courseid: Number(courseid),\n      sectionid: Number(sectionid),\n      sectionnum: Number(sectionnum),\n      beforemod: beforemod ? Number(beforemod) : null,\n    };\n  };\n\n  const openChatModal = async (payload) => {\n    try {\n      // Si ya hay un modal abierto, cerrarlo primero\n      if (modal) {\n        await modal.destroy();\n        modal = null;\n      }\n\n      const bodyHTML = await Templates.render('local_datacurso/add_activity_ai_modal', {});\n\n      const title = await Str.get_string('addactivityai_modaltitle', 'local_datacurso');\n\n      modal = await Modal.create({\n        title,\n        large: true,\n        show: true,\n        removeOnClose: true,\n      });\n\n      // Manejar el evento de cierre del modal\n      modal.getRoot().on('hidden.bs.modal', () => {\n        if (modal) {\n          modal.destroy();\n          modal = null;\n        }\n      });\n\n      await modal.setBody(bodyHTML);\n      // No llamar a show() nuevamente; el modal ya fue creado con show: true.\n\n      // Handlers del chat\n      const bodyEl = modal.getBody()[0];\n      wireChatHandlers(bodyEl, payload);\n\n    } catch (err) {\n      Notification.exception(err);\n    }\n  };\n\n  const wireChatHandlers = (container, payload) => {\n    const messagesEl = container.querySelector('.bdai-messages');\n    const form = container.querySelector('form.bdai-input');\n    const textarea = form.querySelector('textarea');\n    const sendBtn = form.querySelector('.bdai-send');\n\n    // Mensaje de bienvenida.\n    Str.get_string('addactivityai_welcome', 'local_datacurso').then((s) => {\n      pushAI(messagesEl, s);\n    });\n\n    // Enviar con submit.\n    form.addEventListener('submit', async (e) => {\n      e.preventDefault();\n      const prompt = textarea.value.trim();\n      if (!prompt) return;\n\n      pushUser(messagesEl, prompt);\n      textarea.value = '';\n      textarea.focus();\n\n      // Llamada al WS\n      setLoading(sendBtn, true);\n      const typing = pushTyping(messagesEl);\n      try {\n        const response = await chatbotRepository.createMod({ ...payload, prompt });\n        removeTyping(typing);\n        renderWSResult(messagesEl, response);\n        \n        // Cerrar modal antes de redirigir\n        if (modal) {\n          await modal.hide();\n        }\n        \n        setTimeout(() => {\n          window.location.href = response.courseurl;\n        }, 500); // Pequeño delay para que se vea el mensaje de éxito\n        \n      } catch (err) {\n        removeTyping(typing);\n        Str.get_string('addactivityai_error', 'local_datacurso').then((s) => {\n          pushAI(messagesEl, `❌ ${s}`);\n        });\n        Notification.exception(err);\n      } finally {\n        setLoading(sendBtn, false);\n        scrollToBottom(messagesEl);\n      }\n    });\n\n    // Enter para enviar (sin Ctrl, ya que es más común en chat)\n    textarea.addEventListener('keydown', (e) => {\n      if (e.key === 'Enter' && !e.shiftKey) {\n        e.preventDefault();\n        form.requestSubmit();\n      }\n    });\n  };\n\n  const pushUser = (wrap, text) => addBubble(wrap, text, 'user');\n  const pushAI = (wrap, text) => addBubble(wrap, text, 'ai');\n\n  const addBubble = (wrap, text, role) => {\n    const row = document.createElement('div');\n    row.className = `bdai-msg ${role}`;\n    const b = document.createElement('div');\n    b.className = 'bubble';\n    b.textContent = text;\n    row.appendChild(b);\n    wrap.appendChild(row);\n    scrollToBottom(wrap);\n  };\n\n  const pushTyping = (wrap) => {\n    const row = document.createElement('div');\n    row.className = 'bdai-msg ai bdai-typing';\n    const b = document.createElement('div');\n    b.className = 'bubble';\n    b.innerHTML = '<span class=\"dot\"></span><span class=\"dot\"></span><span class=\"dot\"></span>';\n    row.appendChild(b);\n    wrap.appendChild(row);\n    scrollToBottom(wrap);\n    return row;\n  };\n\n  const removeTyping = (el) => el?.remove();\n\n  const scrollToBottom = (wrap) => {\n    wrap.scrollTop = wrap.scrollHeight;\n  };\n\n  const setLoading = (btn, isLoading) => {\n    btn.disabled = isLoading;\n    btn.style.opacity = isLoading ? .7 : 1;\n  };\n\n  const renderWSResult = (wrap, res) => {\n    const lines = [];\n    if (res?.success === false) {\n      if (res?.message) {\n        pushAI(wrap, res.message);\n      } else {\n        Str.get_string('addactivityai_faildefault', 'local_datacurso').then((s) => pushAI(wrap, s));\n      }\n      return;\n    }\n\n    if (res?.message) lines.push(res.message);\n    if (res?.name && res?.type) {\n      Str.get_string('addactivityai_created_named', 'local_datacurso', {type: res.type, name: res.name})\n        .then((s) => lines.push(`✅ ${s}`));\n    } else if (res?.cmid) {\n      Str.get_string('addactivityai_created_cmid', 'local_datacurso', res.cmid)\n        .then((s) => lines.push(`✅ ${s}`));\n    }\n    if (res?.warnings?.length) {\n      Str.get_string('addactivityai_warnings_prefix', 'local_datacurso', res.warnings.join(' '))\n        .then((s) => lines.push(`⚠️ ${s}`));\n    }\n\n    if (res?.preview || res?.log) {\n      const extras = document.createElement('div');\n      extras.className = 'bdai-msg ai';\n      const b = document.createElement('div');\n      b.className = 'bubble';\n      const pre = document.createElement('pre');\n      pre.style.whiteSpace = 'pre-wrap';\n      pre.textContent = (res.preview || res.log);\n      b.appendChild(pre);\n      extras.appendChild(b);\n      wrap.appendChild(extras);\n    }\n\n    if (lines.length) {\n      pushAI(wrap, lines.join('\\n'));\n      setTimeout(() => {\n        const last = wrap.querySelector('.bdai-msg.ai:last-child .bubble');\n        if (last) last.textContent = lines.join('\\n');\n      }, 50);\n    } else {\n      Str.get_string('addactivityai_done', 'local_datacurso').then((s) => pushAI(wrap, s));\n    }\n  };\n\n  return { init };\n});"],"names":["define","Templates","Notification","Modal","CustomEvents","Str","chatbotRepository","modal","initialized","readDataset","el","courseid","sectionid","sectionnum","beforemod","dataset","Number","openChatModal","async","destroy","bodyHTML","render","title","get_string","create","large","show","removeOnClose","getRoot","on","setBody","bodyEl","getBody","wireChatHandlers","payload","err","exception","container","messagesEl","querySelector","form","textarea","sendBtn","then","s","pushAI","addEventListener","e","preventDefault","prompt","value","trim","pushUser","focus","setLoading","typing","pushTyping","response","createMod","removeTyping","renderWSResult","hide","setTimeout","window","location","href","courseurl","scrollToBottom","key","shiftKey","requestSubmit","wrap","text","addBubble","role","row","document","createElement","className","b","textContent","appendChild","innerHTML","remove","scrollTop","scrollHeight","btn","isLoading","disabled","style","opacity","res","lines","success","message","push","name","type","cmid","warnings","_res$warnings","length","join","preview","log","extras","pre","whiteSpace","last","init","events","activate","keyboardActivate","forEach","event","link","target","closest"],"mappings":"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"}