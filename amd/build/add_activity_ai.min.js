/**
 * TODO describe module add_activity_ai
 *
 * @module     local_datacurso/add_activity_ai
 * @copyright  2025 Buendata <soluciones@buendata.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_datacurso/add_activity_ai",["core/templates","core/notification","core/modal","core/custom_interaction_events","core/str","local_datacurso/repository/chatbot"],((Templates,Notification,Modal,CustomEvents,Str,chatbotRepository)=>{let modal=null,initialized=!1;const readDataset=el=>{const{courseid:courseid,sectionid:sectionid,sectionnum:sectionnum,beforemod:beforemod}=el.dataset;return{courseid:Number(courseid),sectionid:Number(sectionid),sectionnum:Number(sectionnum),beforemod:beforemod?Number(beforemod):null}},openChatModal=async payload=>{try{modal&&(await modal.destroy(),modal=null);const bodyHTML=await Templates.render("local_datacurso/add_activity_ai_modal",{}),title=await Str.get_string("addactivityai_modaltitle","local_datacurso");modal=await Modal.create({title:title,large:!0,show:!0,removeOnClose:!0}),modal.getRoot().on("hidden.bs.modal",(()=>{modal&&(modal.destroy(),modal=null)})),await modal.setBody(bodyHTML);const bodyEl=modal.getBody()[0];wireChatHandlers(bodyEl,payload)}catch(err){Notification.exception(err)}},wireChatHandlers=(container,payload)=>{const messagesEl=container.querySelector(".bdai-messages"),form=container.querySelector("form.bdai-input"),textarea=form.querySelector("textarea"),sendBtn=form.querySelector(".bdai-send");Str.get_string("addactivityai_welcome","local_datacurso").then((s=>{pushAI(messagesEl,s)})),form.addEventListener("submit",(async e=>{e.preventDefault();const prompt=textarea.value.trim();if(!prompt)return;pushUser(messagesEl,prompt),textarea.value="",textarea.focus(),setLoading(sendBtn,!0);const typing=pushTyping(messagesEl);try{const response=await chatbotRepository.createMod({...payload,prompt:prompt});removeTyping(typing),renderWSResult(messagesEl,response),modal&&await modal.hide(),setTimeout((()=>{window.location.href=response.courseurl}),500)}catch(err){removeTyping(typing),Str.get_string("addactivityai_error","local_datacurso").then((s=>{pushAI(messagesEl,"❌ ".concat(s))})),Notification.exception(err)}finally{setLoading(sendBtn,!1),scrollToBottom(messagesEl)}})),textarea.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),form.requestSubmit())}))},pushUser=(wrap,text)=>addBubble(wrap,text,"user"),pushAI=(wrap,text)=>addBubble(wrap,text,"ai"),addBubble=(wrap,text,role)=>{const row=document.createElement("div");row.className="bdai-msg ".concat(role);const b=document.createElement("div");b.className="bubble",b.textContent=text,row.appendChild(b),wrap.appendChild(row),scrollToBottom(wrap)},pushTyping=wrap=>{const row=document.createElement("div");row.className="bdai-msg ai bdai-typing";const b=document.createElement("div");return b.className="bubble",b.innerHTML='<span class="dot"></span><span class="dot"></span><span class="dot"></span>',row.appendChild(b),wrap.appendChild(row),scrollToBottom(wrap),row},removeTyping=el=>null==el?void 0:el.remove(),scrollToBottom=wrap=>{wrap.scrollTop=wrap.scrollHeight},setLoading=(btn,isLoading)=>{btn.disabled=isLoading,btn.style.opacity=isLoading?.7:1},renderWSResult=(wrap,res)=>{var _res$warnings;const lines=[];if(!1!==(null==res?void 0:res.success)){if(null!=res&&res.message&&lines.push(res.message),null!=res&&res.name&&null!=res&&res.type?Str.get_string("addactivityai_created_named","local_datacurso",{type:res.type,name:res.name}).then((s=>lines.push("✅ ".concat(s)))):null!=res&&res.cmid&&Str.get_string("addactivityai_created_cmid","local_datacurso",res.cmid).then((s=>lines.push("✅ ".concat(s)))),null!=res&&null!==(_res$warnings=res.warnings)&&void 0!==_res$warnings&&_res$warnings.length&&Str.get_string("addactivityai_warnings_prefix","local_datacurso",res.warnings.join(" ")).then((s=>lines.push("⚠️ ".concat(s)))),null!=res&&res.preview||null!=res&&res.log){const extras=document.createElement("div");extras.className="bdai-msg ai";const b=document.createElement("div");b.className="bubble";const pre=document.createElement("pre");pre.style.whiteSpace="pre-wrap",pre.textContent=res.preview||res.log,b.appendChild(pre),extras.appendChild(b),wrap.appendChild(extras)}lines.length?(pushAI(wrap,lines.join("\n")),setTimeout((()=>{const last=wrap.querySelector(".bdai-msg.ai:last-child .bubble");last&&(last.textContent=lines.join("\n"))}),50)):Str.get_string("addactivityai_done","local_datacurso").then((s=>pushAI(wrap,s)))}else null!=res&&res.message?pushAI(wrap,res.message):Str.get_string("addactivityai_faildefault","local_datacurso").then((s=>pushAI(wrap,s)))};return{init:()=>{if(initialized)return;initialized=!0;const events=["click",CustomEvents.events.activate,CustomEvents.events.keyboardActivate];CustomEvents.define(document,events),events.forEach((event=>{document.addEventListener(event,(async e=>{const link=e.target.closest('[data-action="local_datacurso/add_activity_ai"]');if(!link)return;e.preventDefault();const payload=readDataset(link);await openChatModal(payload)}))}))}}}));

//# sourceMappingURL=add_activity_ai.min.js.map