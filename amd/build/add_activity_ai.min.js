/**
 * TODO describe module add_activity_ai
 *
 * @module     local_datacurso/add_activity_ai
 * @copyright  2025 Buendata <soluciones@buendata.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_datacurso/add_activity_ai",["core/templates","core/notification","core/modal","core/custom_interaction_events","core/str","local_datacurso/repository/chatbot","local_datacurso/module_streaming"],((Templates,Notification,Modal,CustomEvents,Str,chatbotRepository,moduleStreaming)=>{let modal=null,initialized=!1;const readDataset=el=>{const{sectionnum:sectionnum,beforemod:beforemod}=el.dataset;return{sectionnum:Number(sectionnum),beforemod:beforemod?Number(beforemod):null}},openChatModal=async payload=>{try{modal&&(await modal.destroy(),modal=null);const bodyHTML=await Templates.render("local_datacurso/add_activity_ai_modal",{}),title=await Str.get_string("addactivityai_modaltitle","local_datacurso");modal=await Modal.create({title:title,body:bodyHTML,large:!0,scrollable:!0,removeOnClose:!0}),modal.getRoot().addClass("local_datacurso_course_ai_modal"),modal.show(),modal.getRoot().on("hidden.bs.modal",(()=>{modal&&(modal.destroy(),modal=null)}));const bodyEl=modal.getBody()[0];wireChatHandlers(bodyEl,payload)}catch(err){Notification.exception(err)}},wireChatHandlers=(container,payload)=>{const messagesEl=container.querySelector(".local_datacurso_ai_messages"),form=container.querySelector("form.local_datacurso_ai_input"),textarea=form.querySelector("textarea"),sendBtn=form.querySelector(".local_datacurso_ai_send");Str.get_string("addactivityai_welcome","local_datacurso").then((s=>{pushAI(messagesEl,s)})),form.addEventListener("submit",(async e=>{e.preventDefault();const prompt=textarea.value.trim();if(!prompt)return;const generateImages=document.querySelector('input[name="generate_images"]:checked').value;pushUser(messagesEl,prompt),textarea.value="",sendBtn.disabled=!0,textarea.disabled=!0;const radioButtons=document.querySelectorAll('input[name="generate_images"]');radioButtons.forEach((rb=>{rb.disabled=!0})),setLoading(sendBtn,!0);try{const response=await chatbotRepository.createModStream({...payload,prompt:prompt,generateimages:generateImages});if(!response.ok)throw new Error(response.message);messagesEl.innerHTML="";const streamingContainer=document.createElement("div");streamingContainer.innerHTML='\n          <div data-region="local_datacurso/module_streaming/progress" style="display: block;">\n            <div class="d-flex align-items-center mb-3">\n              <div data-region="local_datacurso/module_streaming/progress/icon" class="me-2">\n                <div class="spinner-border spinner-border-sm text-primary" role="status">\n                  <span class="visually-hidden">Loading...</span>\n                </div>\n              </div>\n              <div>\n                <h6 class="mb-0">Creando módulo...</h6>\n                <small class="text-muted">Por favor espera mientras se genera el contenido</small>\n              </div>\n            </div>\n          </div>\n          <div data-region="local_datacurso/module_streaming" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;"></div>\n        ',messagesEl.appendChild(streamingContainer),await moduleStreaming.startModuleStreaming(response.streamingurl,streamingContainer,{courseid:payload.courseid,sectionnum:payload.sectionnum,beforemod:payload.beforemod,jobid:response.job_id})}catch(err){if(console.error("Error starting module creation:",err),err&&err.message)pushAI(messagesEl,"❌ Error: ".concat(err.message));else{const errorMsg=await Str.get_string("addactivityai_error","local_datacurso");pushAI(messagesEl,"❌ ".concat(errorMsg))}}finally{radioButtons.forEach((rb=>{rb.disabled=!1})),textarea.disabled=!1,sendBtn.disabled=!1,setLoading(sendBtn,!1),scrollToBottom(messagesEl)}})),textarea.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),form.requestSubmit())}))},pushUser=(wrap,text)=>addBubble(wrap,text,"user"),pushAI=(wrap,text)=>addBubble(wrap,text,"ai"),addBubble=(wrap,text,role)=>{const row=document.createElement("div");row.className="local_datacurso_ai_msg ".concat(role);const b=document.createElement("div");b.className="bubble",b.textContent=text,row.appendChild(b),wrap.appendChild(row),scrollToBottom(wrap)},scrollToBottom=wrap=>{wrap.scrollTop=wrap.scrollHeight},setLoading=(btn,isLoading)=>{btn.disabled=isLoading,btn.style.opacity=isLoading?.7:1};return{init:()=>{if(initialized)return;initialized=!0;const events=["click",CustomEvents.events.activate,CustomEvents.events.keyboardActivate];CustomEvents.define(document,events),events.forEach((event=>{document.addEventListener(event,(async e=>{const link=e.target.closest('[data-action="local_datacurso/add_activity_ai"]');if(!link)return;e.preventDefault();const payload=readDataset(link);await openChatModal(payload)}))}))},openChatModal:openChatModal}}));

//# sourceMappingURL=add_activity_ai.min.js.map