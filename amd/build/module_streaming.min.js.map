{"version":3,"file":"module_streaming.min.js","sources":["../src/module_streaming.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Module Streaming Module for handling real-time module generation\n *\n * @module     local_datacurso/module_streaming\n * @copyright  2025 Buendata <soluciones@buendata.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport { get_string } from \"core/str\";\nimport { createMod } from \"local_datacurso/repository/chatbot\";\n\n\n/**\n * Add status message to the streaming container\n * @param {string} message - Status message\n * @param {string} type - Status type (info, success, warning, error)\n * @param {Element} container - Container element\n */\nconst addStatus = (message, type, container) => {\n  const statusDiv = document.createElement(\"div\");\n  statusDiv.className = `alert alert-${\n    type === \"success\" ? \"success\" : type === \"error\" ? \"danger\" : type === \"warning\" ? \"warning\" : \"info\"\n  } mb-2`;\n  statusDiv.innerHTML = `<small>${message}</small>`;\n  container.appendChild(statusDiv);\n  container.scrollTop = container.scrollHeight;\n};\n\n/**\n * Start module streaming from the provided URL\n * @param {string} streamingUrl - The EventSource URL for streaming\n * @param {Element} container - Container element for displaying results\n * @param {Object} params - Additional parameters (courseid, sectionnum, beforemod)\n */\nexport const startModuleStreaming = async (streamingUrl, container, params = {}) => {\n  const progressIndicator = container.querySelector(\n    \"[data-region='local_datacurso/course_streaming/progress']\"\n  );\n  const eventList = container.querySelector(\n    \"[data-region='local_datacurso/course_streaming']\"\n  );\n  const progressIcon = container.querySelector(\n    \"[data-region='local_datacurso/course_streaming/progress/icon']\"\n  );\n\n  // Clear previous content\n  if (eventList) {\n    eventList.innerHTML = \"\";\n  }\n  if (progressIndicator) {\n    progressIndicator.style.display = \"block\";\n  }\n\n  const es = new EventSource(streamingUrl);\n\n  // Essential event handlers for module creation\n  const onResourceStart = async (e) => {\n    console.log(\"onResourceStart\", e);\n    const message = await get_string('module_streaming_start', 'local_datacurso');\n    addStatus(message, \"info\", eventList);\n  };\n\n  const onSchemaStart = async (e) => {\n    console.log(\"onSchemaStart\", e);\n    const message = await get_string('module_streaming_schema_start', 'local_datacurso');\n    addStatus(message, \"info\", eventList);\n  };\n\n  const onSchemaDone = async (e) => {\n    console.log(\"onSchemaDone\", e);\n    const message = await get_string('module_streaming_schema_done', 'local_datacurso');\n    addStatus(message, \"success\", eventList);\n  };\n\n  const onImagesStart = async (e) => {\n    console.log(\"onImagesStart\", e);\n    const message = await get_string('module_streaming_images_start', 'local_datacurso');\n    addStatus(message, \"info\", eventList);\n  };\n\n  const onImagesDone = async (e) => {\n    console.log(\"onImagesDone\", e);\n    const message = await get_string('module_streaming_images_done', 'local_datacurso');\n    addStatus(message, \"success\", eventList);\n  };\n\n  const onParametersStart = async (e) => {\n    console.log(\"onParametersStart\", e);\n    const message = await get_string('module_streaming_parameters_start', 'local_datacurso');\n    addStatus(message, \"info\", eventList);\n  };\n\n  const onParametersDone = async (e) => {\n    console.log(\"onParametersDone\", e);\n    const message = await get_string('module_streaming_parameters_done', 'local_datacurso');\n    addStatus(message, \"success\", eventList);\n  };\n\n  const onOutputStart = async (e) => {\n    console.log(\"onOutputStart\", e);\n    const message = await get_string('module_streaming_output_start', 'local_datacurso');\n    addStatus(message, \"info\", eventList);\n  };\n\n  const onResourceComplete = async (e) => {\n    console.log(\"onResourceComplete\", e);\n\n    // Close the EventSource connection first\n    es.close();\n    \n    if (progressIcon) {\n      progressIcon.innerHTML = `\n        <div class=\"bg-success rounded-circle d-flex align-items-center justify-content-center\" style=\"width: 1.5rem; height: 1.5rem;\">\n          <i class=\"text-white\" style=\"font-size: 0.8rem;\">✓</i>\n        </div>\n      `;\n    }\n\n    const completeMessage = await get_string('module_streaming_complete', 'local_datacurso');\n    addStatus(completeMessage, \"success\", eventList);\n\n    try {\n      const { createMod } = await import('local_datacurso/repository/chatbot');\n      const response = await createMod({\n        courseid: params.courseid,\n        sectionnum: params.sectionnum,\n        beforemod: params.beforemod,\n        jobid: params.jobid,\n      });\n      if (response && response.ok) {\n        const successMessage = await get_string('module_streaming_added_success', 'local_datacurso');\n        addStatus(successMessage, \"success\", eventList);\n        setTimeout(() => {\n          window.location.href = response.data.activityurl;\n        }, 100);\n      } else {\n        const defaultError = await get_string('module_streaming_add_error', 'local_datacurso');\n        const msg = (response && response.message) ? response.message : defaultError;\n        addStatus(`⚠️ ${msg}`, \"error\", eventList);\n      }\n    } catch (err) {\n      console.error('Error al crear la actividad desde resource_complete:', err);\n      const errorMessage = await get_string('module_streaming_add_problem', 'local_datacurso', err?.message || err);\n      addStatus(`⚠️ ${errorMessage}`, \"error\", eventList);\n    }\n  };\n\n  const onError = async (e) => {\n    console.error(\"Streaming error:\", e);\n    es.close();\n    const errorMessage = await get_string('module_streaming_creation_error', 'local_datacurso');\n    addStatus(errorMessage, \"error\", eventList);\n  };\n\n  const generateImages = Number(params.generateimages) || 0;\n\n  // Register only essential event listeners for better user experience\n  es.addEventListener(\"resource_start\", onResourceStart);\n  es.addEventListener(\"resource_schema_start\", onSchemaStart);\n  es.addEventListener(\"resource_schema_done\", onSchemaDone);\n  if (generateImages === 1) {\n    es.addEventListener(\"resource_images_start\", onImagesStart);\n    es.addEventListener(\"resource_images_done\", onImagesDone);\n  }\n  es.addEventListener(\"resource_parameters_start\", onParametersStart);\n  es.addEventListener(\"resource_parameters_done\", onParametersDone);\n  es.addEventListener(\"resource_output_start\", onOutputStart);\n  es.addEventListener(\"resource_complete\", onResourceComplete);\n  es.addEventListener(\"error\", onError);\n};\n"],"names":["addStatus","message","type","container","statusDiv","document","createElement","className","innerHTML","appendChild","scrollTop","scrollHeight","async","streamingUrl","params","progressIndicator","querySelector","eventList","progressIcon","style","display","es","EventSource","onResourceStart","console","log","e","onSchemaStart","onSchemaDone","onImagesStart","onImagesDone","onParametersStart","onParametersDone","onOutputStart","onResourceComplete","close","completeMessage","createMod","response","courseid","sectionnum","beforemod","jobid","ok","successMessage","setTimeout","window","location","href","data","activityurl","defaultError","msg","err","error","errorMessage","onError","generateImages","Number","generateimages","addEventListener"],"mappings":"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"}